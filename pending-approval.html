<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YANA — Rider Dashboard</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --bg:#071014; --card: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.12);
  --accent:#00eaff; --text:#eaf4f8; --r:16px;
}
body{margin:0;font-family:Inter,Arial;background:#061014;color:var(--text);}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.header h1{margin:0;font-size:1rem;color:var(--accent)}
.container{padding:14px;display:flex;justify-content:center}
.card{width:92vw;max-width:520px;background:var(--card);border-radius:var(--r);padding:18px;border:1px solid var(--border)}
.title{font-size:1.2rem;color:var(--accent);margin-bottom:8px}
.timerRow{display:flex;gap:12px}
.block{flex:1;background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid var(--border);text-align:center}
.block .label{font-size:0.9rem;color:#bcd;margin-bottom:6px}
.block .value{font-size:1.6rem;font-weight:700}
.controls{display:flex;gap:10px;margin-top:14px}
.btn{flex:1;padding:12px;border-radius:12px;border:none;font-weight:700;cursor:pointer;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;gap:6px}
.btn.secondary{background:transparent;color:var(--accent);border:2px solid var(--accent);padding:6px 10px;font-size:0.85rem}
.info{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
.info .pill{flex:1;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);text-align:center}
.bottomNav{position:fixed;left:0;right:0;bottom:0;padding:10px;background:var(--card);display:flex;justify-content:space-around;border-top:1px solid var(--border)}
.navBtn{color:var(--text);font-size:0.85rem;cursor:pointer;display:flex;flex-direction:column;align-items:center}
</style>
</head>
<body>

<div class="header">
  <h1>⚡ YANA Rider</h1>
  <button id="logoutBtn" class="btn secondary">Logout</button>
</div>

<div class="container">
  <div class="card">
    <div class="title">Rider Dashboard</div>
    <div id="riderName">Loading...</div>

    <!-- Rental Timer Block -->
    <div class="block" style="margin-bottom:12px;background:rgba(255,255,255,0.03);border:1px solid var(--border);">
      <div class="label">Rental Time Left</div>
      <div id="rentalTimer" class="value">--:--:--:--</div>
    </div>

    <div class="timerRow">
      <div class="block">
        <div class="label">Working Hours</div>
        <div id="workValue" class="value">00:00:00</div>
      </div>
      <div class="block">
        <div class="label">Break Time</div>
        <div id="breakValue" class="value">00:00:00</div>
      </div>
    </div>

    <div class="controls">
      <button id="punchBtn" class="btn"><i class="fa-solid fa-clock"></i><span id="punchLabel">Punch In</span></button>
      <button id="breakBtn" class="btn secondary"><i class="fa-solid fa-coffee"></i><span id="breakLabel">Start Break</span></button>
    </div>

    <div class="info">
      <div class="pill">Scooty: <strong id="scooty">--</strong></div>
      <div class="pill">Battery: <strong id="battery">--</strong></div>
    </div>
    <div style="margin-top:8px;font-size:0.85rem" id="statusLine">Status: --</div>
  </div>
</div>

<div class="bottomNav">
  <div class="navBtn" id="navScanner"><i class="fa-solid fa-qrcode"></i><div>Scanner</div></div>
  <div class="navBtn" id="navIssues"><i class="fa-solid fa-triangle-exclamation"></i><div>Issues</div></div>
  <div class="navBtn" id="navAttendance"><i class="fa-solid fa-user-check"></i><div>Attendance</div></div>
  <div class="navBtn" id="navLogs"><i class="fa-solid fa-file-lines"></i><div>Logs</div></div>
</div>

<script>
(async function(){
  if(typeof firebase==='undefined' || typeof db==='undefined'){ alert("Firebase not configured"); return; }

  const email = new URLSearchParams(window.location.search).get('email');
  if(!email){ location.href="rider-signin.html"; return; }

  function todayKey(){
    const now = new Date();
    if(now.getHours()<2){ now.setDate(now.getDate()-1); }
    return now.toISOString().slice(0,10);
  }

  let currentDay = todayKey();
  const stateRef = ()=> db.collection("attendance").doc(`${email}_${currentDay}_state`);

  let state = { punchedIn:false, punchInTime:null, workingSeconds:0, onBreak:false, breakStartTime:null, totalBreakSeconds:0 };

  const workValue=document.getElementById("workValue"), breakValue=document.getElementById("breakValue");
  const punchLabel=document.getElementById("punchLabel"), breakLabel=document.getElementById("breakLabel");
  const statusLine=document.getElementById("statusLine");

  const pad=n=>String(n).padStart(2,"0");
  const fmt=s=>`${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(s%60)}`;

  function computeTimes(){
    const now=Date.now();
    let workSecs=state.workingSeconds;
    if(state.punchedIn && state.punchInTime && !state.onBreak){
      workSecs += Math.floor((now - state.punchInTime)/1000);
    }
    let breakSecs=state.totalBreakSeconds;
    if(state.onBreak && state.breakStartTime){
      breakSecs += Math.floor((now - state.breakStartTime)/1000);
    }
    return {workSecs, breakSecs};
  }

  function updateUI(){
    const {workSecs, breakSecs}=computeTimes();
    workValue.innerText=fmt(workSecs);
    breakValue.innerText=fmt(breakSecs);
    punchLabel.innerText=state.punchedIn?"Punch Out":"Punch In";
    breakLabel.innerText=state.onBreak?"Stop Break":"Start Break";
    statusLine.innerText=`Status: ${state.onBreak?"On Break":(state.punchedIn?"Working":"Idle")}`;
  }

  function startTickers(){
    setInterval(updateUI,1000);
    setInterval(autoPunchoutAt2AM,60000);
  }

  async function syncToServer(){
    await stateRef().set({
      punchedIn:state.punchedIn,
      punchInTime: state.punchInTime? firebase.firestore.Timestamp.fromMillis(state.punchInTime):null,
      onBreak:state.onBreak,
      breakStartTime: state.breakStartTime? firebase.firestore.Timestamp.fromMillis(state.breakStartTime):null,
      workingSeconds:state.workingSeconds,
      totalBreakSeconds:state.totalBreakSeconds,
      lastUpdated:firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }

  async function logEvent(type){
    await db.collection("attendance").add({
      email,
      type,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      day: currentDay
    });
  }

  function applySnapshot(d){
    state.punchedIn=d.punchedIn;
    state.onBreak=d.onBreak;
    state.workingSeconds=d.workingSeconds||0;
    state.totalBreakSeconds=d.totalBreakSeconds||0;
    state.punchInTime=d.punchInTime?d.punchInTime.toMillis():null;
    state.breakStartTime=d.breakStartTime?d.breakStartTime.toMillis():null;
    updateUI();
  }

  async function loadState(){
    const snap=await stateRef().get();
    if(snap.exists){ applySnapshot(snap.data()); }
  }

  // Punch & Break logic here...
  // --- RENTAL TIMER WITH ROLLOVER ---
  const rentalTimerEl = document.getElementById("rentalTimer");

  async function updateRentalTimer() {
    // Fetch active scooty assigned to this rider
    const scootySnap = await db.collection("scooty_master")
      .where("assignedTo", "==", email)
      .where("state", "==", "active")
      .get();

    if (scootySnap.empty) {
      rentalTimerEl.innerText = "--:--:--:--";
      return;
    }

    const scootyDoc = scootySnap.docs[0];
    const scootyData = scootyDoc.data();

    // If rentalStart/end not present, initialize in scooty_master
    if (!scootyData.rentalStart || !scootyData.rentalEnd) {
      const now = new Date();
      const planDays = parseInt(scootyData.rentalPlan) || 0;
      const rentalStart = now;
      const rentalEnd = new Date(now);
      rentalEnd.setDate(rentalEnd.getDate() + planDays);

      await scootyDoc.ref.set({
        rentalStart: firebase.firestore.Timestamp.fromDate(rentalStart),
        rentalEnd: firebase.firestore.Timestamp.fromDate(rentalEnd),
        rolloverTime: 0 // initially 0
      }, { merge: true });

      scootyData.rentalStart = firebase.firestore.Timestamp.fromDate(rentalStart);
      scootyData.rentalEnd = firebase.firestore.Timestamp.fromDate(rentalEnd);
      scootyData.rolloverTime = 0;
    }

    const now = new Date();
    const end = scootyData.rentalEnd.toDate();
    let remainingMs = end - now + (scootyData.rolloverTime || 0);

    if (remainingMs < 0) remainingMs = 0;

    const days = Math.floor(remainingMs / (1000 * 60 * 60 * 24));
    remainingMs %= (1000 * 60 * 60 * 24);
    const hours = Math.floor(remainingMs / (1000 * 60 * 60));
    remainingMs %= (1000 * 60 * 60);
    const minutes = Math.floor(remainingMs / (1000 * 60));
    const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);

    rentalTimerEl.innerText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
  }

  setInterval(updateRentalTimer, 1000);
  updateRentalTimer();

  // --- Real-time Scooty & Battery Updates ---
  db.collection("scooty_master")
    .where("assignedTo", "==", email)
    .where("state", "==", "active")
    .onSnapshot(snap => {
      const scootyEl = document.getElementById("scooty");
      if (!snap.empty) {
        const scootyIds = snap.docs.map(d => d.id).join(", ");
        scootyEl.innerText = scootyIds;
      } else scootyEl.innerText = "--";
    });

  db.collection("battery_master")
    .where("assignedTo", "==", email)
    .where("state", "==", "active")
    .onSnapshot(snap => {
      const batteryEl = document.getElementById("battery");
      if (!snap.empty) {
        const batteryIds = snap.docs.map(d => d.id).join(", ");
        batteryEl.innerText = batteryIds;
      } else batteryEl.innerText = "--";
    });

  // --- Navigation ---
  document.getElementById("navScanner").onclick = () => location.href = `scanner.html?email=${email}`;
  document.getElementById("navIssues").onclick = () => location.href = `issue.html?email=${email}`;
  document.getElementById("navAttendance").onclick = () => location.href = `rider-dashboard.html?email=${email}`;
  document.getElementById("navLogs").onclick = () => location.href = `rider-logs.html?email=${email}`;

  // --- Load rider info ---
  const u = await db.collection("users").doc(email).get();
  if (u.exists) {
    document.getElementById("riderName").innerText = u.data().name + " (" + email + ")";
  }

  // --- Auto Punch Out at 2AM ---
  async function autoPunchoutAt2AM() {
    const now = new Date();
    if (now.getHours() === 2 && now.getMinutes() === 0) {
      if (state.punchedIn && state.punchInTime) {
        state.workingSeconds += Math.floor((now - state.punchInTime) / 1000);
      }
      if (state.onBreak && state.breakStartTime) {
        state.totalBreakSeconds += Math.floor((now - state.breakStartTime) / 1000);
      }
      if (state.punchedIn) await logEvent("PunchOut");
      state.punchedIn = false;
      state.punchInTime = null;
      state.onBreak = false;
      state.breakStartTime = null;
      await syncToServer();
      state.workingSeconds = 0;
      state.totalBreakSeconds = 0;
      currentDay = todayKey();
    }
  }

})();
</script>
</body>
</html>
