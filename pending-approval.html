<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>⚡ YANA Admin — Pending Approvals</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root { --radius:14px; --bg2:rgba(10,15,18,0.85); --action:#00eaff; --border:rgba(255,255,255,0.1); --text:#eaf4f8; --transition:0.3s; }

    .tabs { display: flex; gap: 8px; margin-bottom: 12px; }
    .tab { padding: 8px 16px; border-radius: var(--radius); background: var(--bg2); cursor: pointer; }
    .tab.active { background: var(--action); color:#000; font-weight:bold; }

    .card { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; margin-bottom: 12px; backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; transition: var(--transition); cursor:pointer; }
    .card:hover { border-color: var(--action); box-shadow: 0 0 10px var(--action); }
    .card-left { flex: 1; min-width: 200px; }
    .card-right { display: flex; align-items: center; gap: 8px; }

    select { padding: 4px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg2); color: var(--text); }

    #searchBar { width:100%; max-width:100%; box-sizing:border-box; padding:8px 12px; border-radius: var(--radius); margin-bottom:12px; border:1px solid var(--border); background: var(--bg2); color: var(--text); }

    #submitBtn { float:right; color:#fff; }

    .checklist { display:none; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); }
    .checklist label { display:block; margin:4px 0; font-size:0.9rem; }
    .checklist input[type=text] { margin-left:20px; padding:4px; border-radius:6px; border:1px solid var(--border); background: var(--bg2); color: var(--text); width:70%; }
  </style>
</head>
<body>
  <div class="navbar">
    <h2>⚡ YANA Admin — Pending Approvals</h2>
    <div class="profile">
      <div class="profile-pic">A</div>
      <div class="dropdown">
        <button onclick="location.href='admin-dashboard.html'">⬅ Dashboard</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <div class="tab active" id="riderTab">Rider Approvals</div>
      <div class="tab" id="rentalTab">Rental Requests</div>
      <div class="tab" id="returnTab">Return Requests</div>
    </div>

    <input type="text" id="searchBar" placeholder="Search by email, scooty id, name, plan...">

    <div id="riderContainer"></div>
    <div id="rentalContainer" style="display:none;"></div>
    <div id="returnContainer" style="display:none;"></div>

    <button class="menu-btn ripple" id="submitBtn"><i class="fas fa-check"></i> Submit Changes</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const riderContainer = document.getElementById("riderContainer");
    const rentalContainer = document.getElementById("rentalContainer");
    const returnContainer = document.getElementById("returnContainer");
    let pendingRiders = [], pendingRentals = [], pendingReturns = [];
    let activeTab = "riders";

    document.getElementById("riderTab").onclick = () => { switchTab("riders"); };
    document.getElementById("rentalTab").onclick = () => { switchTab("rentals"); };
    document.getElementById("returnTab").onclick = () => { switchTab("returns"); };

    function switchTab(tab){
      activeTab = tab;
      document.getElementById("riderTab").classList.toggle("active", tab==="riders");
      document.getElementById("rentalTab").classList.toggle("active", tab==="rentals");
      document.getElementById("returnTab").classList.toggle("active", tab==="returns");

      riderContainer.style.display = tab==="riders" ? "block" : "none";
      rentalContainer.style.display = tab==="rentals" ? "block" : "none";
      returnContainer.style.display = tab==="returns" ? "block" : "none";
    }

    auth.onAuthStateChanged(async user=>{
      if(!user) return location.href="admin-signin.html";
      document.querySelector(".profile-pic").innerText=(user.email[0]||"A").toUpperCase();
      const doc=await db.collection("users").doc(user.email).get();
      if(!doc.exists||!["admin","captain"].includes(doc.data().role)){
        alert("❌ Access denied. Only Admins or Captains allowed."); return location.href="index.html";
      }
      loadPendingRiders(); loadPendingRentals(); loadPendingReturns();
    });
    document.getElementById("logoutBtn").onclick = ()=>auth.signOut();

    // ---------------- Riders ----------------
    function loadPendingRiders(){
      db.collection("users").where("status","==","pending").onSnapshot(snapshot=>{
        pendingRiders=[]; riderContainer.innerHTML="";
        if(snapshot.empty){ riderContainer.innerHTML="<p>No pending riders.</p>"; return; }
        snapshot.forEach(doc=>{ const d=doc.data(); d.id=doc.id; pendingRiders.push(d); });
        renderRiderCards(pendingRiders);
      });
    }
    function renderRiderCards(list){
      riderContainer.innerHTML="";
      list.forEach(d=>{
        const card=document.createElement("div"); card.className="card";
        card.innerHTML=`
          <div class="card-left">
            <b>${d.name||""}</b><br>Email: ${d.email||""}<br>Vendor: ${d.vendor||""}<br>Partners: ${(d.partners||[]).join(", ")}
          </div>
          <div class="card-right">
            <select data-type="rider" data-id="${d.id}">
              <option value="none" selected>No Action</option>
              <option value="approved">Approve</option>
              <option value="rejected">Reject</option>
            </select>
          </div>
        `;
        riderContainer.appendChild(card);
      });
    }

    // ---------------- Rentals ----------------
    function loadPendingRentals(){
      db.collection("rental_requests").where("status","==","pending").onSnapshot(snapshot=>{
        pendingRentals=[]; rentalContainer.innerHTML="";
        if(snapshot.empty){ rentalContainer.innerHTML="<p>No pending rentals.</p>"; return; }
        snapshot.forEach(doc=>{ const d=doc.data(); d.id=doc.id; pendingRentals.push(d); });
        renderRentalCards(pendingRentals);
      });
    }
    function renderRentalCards(list){
      rentalContainer.innerHTML="";
      list.forEach(d=>{
        const card=document.createElement("div"); card.className="card";
        card.innerHTML=`
          <div class="card-left">
            <b>${d.email||""}</b><br>Scooty: ${d.scootyId||""}<br>Plan: ${d.plan||""} | Amount: ${d.amount||""}<br>Deposit: ${d.depositSelected?d.depositAmount:"No"}
          </div>
          <div class="card-right">
            <select data-type="rental" data-id="${d.id}">
              <option value="none" selected>No Action</option>
              <option value="approved">Approve</option>
              <option value="rejected">Reject</option>
            </select>
          </div>
        `;
        rentalContainer.appendChild(card);
      });
    }

    // ---------------- Returns ----------------
    function loadPendingReturns(){
      db.collection("return_requests").where("status","==","pending").onSnapshot(snapshot=>{
        pendingReturns=[]; returnContainer.innerHTML="";
        if(snapshot.empty){ returnContainer.innerHTML="<p>No pending return requests.</p>"; return; }
        snapshot.forEach(doc=>{ const d=doc.data(); d.id=doc.id; pendingReturns.push(d); });
        renderReturnCards(pendingReturns);
      });
    }

    function renderReturnCards(list){
      returnContainer.innerHTML="";
      list.forEach(d=>{
        const card=document.createElement("div"); card.className="card";
        card.innerHTML=`
          <div class="card-left">
            <b>${d.email||""}</b><br>
            Scooty: ${d.scootyId||""}<br>
            Amount: ${d.amount||""} | Due Date: ${d.dueDate||""} | Excess Days: ${d.excessDays||0}<br>
            Security: ${d.securityDeposit||0}
          </div>
          <div class="card-right">
            <select data-type="return" data-id="${d.id}">
              <option value="none" selected>No Action</option>
              <option value="approved">Approve</option>
              <option value="rejected">Reject</option>
            </select>
          </div>
          <div class="checklist">
            <label><input type="checkbox" value="Nuts & Bolts"> Nuts & Bolts</label>
            <label><input type="checkbox" value="Headlight"> Headlight</label>
            <label><input type="checkbox" value="Backlight"> Backlight</label>
            <label><input type="checkbox" value="Tyres & Rims"> Tyres & Rims</label>
            <label><input type="checkbox" value="Fan"> Fan</label>
            <label><input type="checkbox" value="Number plates"> Number plates</label>
            <label><input type="checkbox" value="Phone Stand"> Phone Stand</label>
            <label><input type="checkbox" value="Foot rest"> Foot rest</label>
            <label><input type="checkbox" value="Side stand"> Side stand</label>
            <label><input type="checkbox" value="Brake levers"> Brake levers</label>
            <label><input type="checkbox" value="Motor"> Motor</label>
            <label><input type="checkbox" value="Battery Health"> Battery Health</label>
            <label><input type="checkbox" value="Scratches"> Scratches</label>
            <label><input type="checkbox" value="Paint loss"> Paint loss</label>
            <label>Others Specify: <input type="text" class="others"></label>
          </div>
        `;
        // click to toggle checklist
        card.querySelector(".card-left").onclick=()=>{ 
          const checklist=card.querySelector(".checklist");
          checklist.style.display = checklist.style.display==="block"?"none":"block";
        };
        returnContainer.appendChild(card);
      });
    }

    // ---------------- Search ----------------
    document.getElementById("searchBar").addEventListener("input",e=>{
      const term=e.target.value.toLowerCase();
      if(activeTab==="riders"){
        renderRiderCards(pendingRiders.filter(d=>
          (d.name||"").toLowerCase().includes(term)||
          (d.email||"").toLowerCase().includes(term)||
          (d.vendor||"").toLowerCase().includes(term)||
          (d.partners||[]).join(", ").toLowerCase().includes(term)
        ));
      } else if(activeTab==="rentals"){
        renderRentalCards(pendingRentals.filter(d=>
          (d.email||"").toLowerCase().includes(term)||
          (d.scootyId||"").toLowerCase().includes(term)||
          (d.plan||"").toLowerCase().includes(term)
        ));
      } else if(activeTab==="returns"){
        renderReturnCards(pendingReturns.filter(d=>
          (d.email||"").toLowerCase().includes(term)||
          (d.scootyId||"").toLowerCase().includes(term)
        ));
      }
    });

    // ---------------- Submit Changes ----------------
    document.getElementById("submitBtn").addEventListener("click",async()=>{
      const selects=document.querySelectorAll("select[data-id]");
      for(let sel of selects){
        const type=sel.dataset.type, id=sel.dataset.id, val=sel.value;
        if(val==="none") continue;
        try{
          if(type==="rider"){
            await db.collection("users").doc(id).update({
              status: val,
              approvedBy: val==="approved"?auth.currentUser.email:null,
              approvedAt: val==="approved"?firebase.firestore.FieldValue.serverTimestamp():null
            });
            await db.collection("logs").add({ email:id, action:"rider_"+val, timestamp:firebase.firestore.FieldValue.serverTimestamp() });
          } else if(type==="rental"){
            const reqRef=db.collection("rental_requests").doc(id);
            const reqSnap=await reqRef.get();
            if(!reqSnap.exists) continue;
            const req=reqSnap.data();
            if(val==="rejected"){
              await reqRef.update({ status:"rejected", rejectedBy:auth.currentUser.email, rejectedAt:firebase.firestore.FieldValue.serverTimestamp() });
              await db.collection("logs").add({ email:req.email, action:"rental_rejected", requestId:id, timestamp:firebase.firestore.FieldValue.serverTimestamp() });
            } else if(val==="approved"){
              await reqRef.update({ status:"approved", approvedBy:auth.currentUser.email, approvedAt:firebase.firestore.FieldValue.serverTimestamp() });
              await db.collection("scooty_master").doc(req.scootyId).update({ status:"assigned", assignedTo:req.email, lastAssignedAt:firebase.firestore.FieldValue.serverTimestamp() });
              if(req.batteryId){ await db.collection("battery_master").doc(req.batteryId).update({ status:"assigned", assignedTo:req.email, lastAssignedAt:firebase.firestore.FieldValue.serverTimestamp() }); }
              const userUpdate={ scootyId:req.scootyId, rentalPlan:req.plan||null, rentalAmount:req.amount||0, lastAssignedAt:firebase.firestore.FieldValue.serverTimestamp() };
              if(req.batteryId) userUpdate.batteryId=req.batteryId;
              if(req.depositSelected){ userUpdate.securityDeposit=req.depositAmount||3000; userUpdate.securityDepositTimestamp=firebase.firestore.FieldValue.serverTimestamp(); }
              await db.collection("users").doc(req.email).set(userUpdate,{merge:true});
              await db.collection("logs").add({ email:req.email, type:"scooty", id:req.scootyId, action:"assign_via_admin", plan:req.plan||null, amount:req.amount||0, depositAmount:req.depositSelected?req.depositAmount||3000:null, approvedBy:auth.currentUser.email, timestamp:firebase.firestore.FieldValue.serverTimestamp() });
              if(req.batteryId){ await db.collection("logs").add({ email:req.email, type:"battery", id:req.batteryId, action:"assign_via_admin", approvedBy:auth.currentUser.email, timestamp:firebase.firestore.FieldValue.serverTimestamp() }); }
            }
          } else if(type==="return"){
            const reqRef=db.collection("return_requests").doc(id);
            const reqSnap=await reqRef.get();
            if(!reqSnap.exists) continue;
            const req=reqSnap.data();
            const card=document.querySelector(`select[data-id="${id}"]`).closest(".card");
            const checklist=card.querySelectorAll(".checklist input[type=checkbox]");
            const othersInput=card.querySelector(".checklist .others");
            const damagedParts=[];
            checklist.forEach(c=>{ if(c.checked) damagedParts.push(c.value); });
            if(othersInput && othersInput.value.trim()) damagedParts.push(othersInput.value.trim());

            if(val==="approved"){
              // update scooty
              await db.collection("scooty_master").doc(req.scootyId).update({ status:"returned", assignedTo:null });
              await db.collection("users").doc(req.email).update({ scootyId:firebase.firestore.FieldValue.delete(), rentalPlan:firebase.firestore.FieldValue.delete(), rentalAmount:firebase.firestore.FieldValue.delete() });
              await reqRef.update({ status:"approved", approvedBy:auth.currentUser.email, approvedAt:firebase.firestore.FieldValue.serverTimestamp(), damagedParts:damagedParts });
              for(let part of damagedParts){
                await db.collection("logs").add({ email:req.email, type:"scooty_return", id:req.scootyId, action:"damage_reported", part, approvedBy:auth.currentUser.email, timestamp:firebase.firestore.FieldValue.serverTimestamp() });
              }
            } else if(val==="rejected"){
              await reqRef.update({ status:"rejected", rejectedBy:auth.currentUser.email, rejectedAt:firebase.firestore.FieldValue.serverTimestamp() });
              await db.collection("logs").add({ email:req.email, type:"scooty_return", id:req.scootyId, action:"return_rejected", approvedBy:auth.currentUser.email, timestamp:firebase.firestore.FieldValue.serverTimestamp() });
            }
          }
        } catch(e){ console.error(e); alert("Failed to process "+type+" ID "+id+": "+e.message); }
      }
      alert("✅ All selected changes applied!");
    });
  </script>
</body>
</html>
