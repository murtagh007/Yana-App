<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — Pending Return Requests</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 12px;
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }
    .card:hover {
      border-color: var(--action);
      box-shadow: 0 0 10px var(--action);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      cursor: pointer;
    }
    .card-details {
      margin-top: 8px;
      display: none;
    }
    .checklist {
      margin-top: 10px;
      padding: 8px;
      background: rgba(255,255,255,0.03);
      border-radius: var(--radius);
    }
    .checklist label {
      display: block;
      margin-bottom: 5px;
    }
    select {
      padding: 4px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
    }
    #searchBar {
      width: 100%;
      box-sizing: border-box;
      padding: 8px 12px;
      border-radius: var(--radius);
      margin-bottom: 12px;
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
    }
    #submitBtn {
      float: right;
      margin-top: 10px;
    }
    textarea {
      width: 100%;
      min-height: 50px;
      margin-top: 6px;
      border-radius: var(--radius);
      padding: 6px;
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
    }
  </style>
</head>
<body>
  <div class="navbar">
    <h2>⚡ YANA Admin</h2>
    <div class="profile">
      <div class="profile-pic">A</div>
      <div class="dropdown">
        <button onclick="location.href='admin-dashboard.html'">⬅ Dashboard</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>Pending Return Requests</h2>
    <p class="muted">Review scooties awaiting return approval. Click a card to open the checklist before approving or rejecting.</p>
    <input type="text" id="searchBar" placeholder="Search by rider, scooty, or email">
    <div id="cardsContainer"></div>
    <button class="menu-btn ripple" id="submitBtn"><i class="fas fa-check"></i> Submit Changes</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const cardsContainer = document.getElementById("cardsContainer");
    let returnRequests = [];

    const checklistItems = [
      "Nuts & Bolts",
      "Headlight",
      "Backlight",
      "Tyres & Rims",
      "Fan",
      "Number plates",
      "Phone Stand",
      "Foot rest",
      "Side stand",
      "Brake levers",
      "Motor",
      "Battery Health",
      "Scratches",
      "Paint loss"
    ];

    auth.onAuthStateChanged(async user => {
      if (!user) return location.href="admin-signin.html";
      document.querySelector(".profile-pic").innerText = (user.email[0]||"A").toUpperCase();

      const doc = await db.collection("users").doc(user.email).get();
      if (!doc.exists || !["admin","captain"].includes(doc.data().role)) {
        alert("❌ Access denied.");
        return location.href="index.html";
      }

      loadReturnRequests();
    });

    document.getElementById("logoutBtn").onclick = () => auth.signOut();

    function loadReturnRequests() {
      db.collection("return_requests").where("status","==","pending")
        .onSnapshot(snapshot => {
          returnRequests = [];
          cardsContainer.innerHTML = "";
          snapshot.forEach(doc => {
            const d = doc.data();
            d.id = doc.id;
            returnRequests.push(d);
          });
          renderCards(returnRequests);
        });
    }

    function renderCards(list) {
      cardsContainer.innerHTML = "";
      list.forEach(d => {
        const card = document.createElement("div");
        card.className = "card";

        // Calculate due date & excess days
        const startDate = d.securityDepositTimestamp?.toDate?.() || new Date();
        const planDays = parseInt(d.rentalPlan.replace("d","")) || 0;
        const dueDate = new Date(startDate);
        dueDate.setDate(startDate.getDate() + planDays);
        const now = new Date();
        const excessDays = now > dueDate ? Math.floor((now - dueDate) / (1000*60*60*24)) : 0;

        card.innerHTML = `
          <div class="card-header">
            <div>
              <b>${d.name || ""}</b> (${d.email || ""})<br>
              Scooty: ${d.scootyId || ""}<br>
              Plan: ${d.rentalPlan || ""} | Rental: ₹${d.rentalAmount || 0} | Deposit: ₹${d.securityDeposit || 0}
            </div>
            <div>
              <select data-id="${d.id}">
                <option value="none" selected>No Action</option>
                <option value="approved">Approve</option>
                <option value="rejected">Reject</option>
              </select>
            </div>
          </div>
          <div class="card-details">
            <p>Start: ${startDate.toDateString()}<br>
               Due: ${dueDate.toDateString()}<br>
               Excess Days: ${excessDays}</p>
            <div class="checklist">
              <b>Checklist</b><br>
              ${checklistItems.map(item => `
                <label><input type="checkbox" data-id="${d.id}" data-item="${item}"> ${item}</label>
              `).join("")}
              <label>Others: <textarea data-id="${d.id}" data-item="Others"></textarea></label>
            </div>
          </div>
        `;

        card.querySelector(".card-header").addEventListener("click", () => {
          const details = card.querySelector(".card-details");
          details.style.display = details.style.display === "none" ? "block" : "none";
        });

        cardsContainer.appendChild(card);
      });
    }

    document.getElementById("searchBar").addEventListener("input", e => {
      const term = e.target.value.toLowerCase();
      renderCards(returnRequests.filter(d =>
        (d.name||"").toLowerCase().includes(term) ||
        (d.email||"").toLowerCase().includes(term) ||
        (d.scootyId||"").toLowerCase().includes(term)
      ));
    });

    document.getElementById("submitBtn").addEventListener("click", async () => {
      const updates = [];
      document.querySelectorAll("select[data-id]").forEach(sel => {
        if (sel.value !== "none") {
          const id = sel.dataset.id;
          const selectedChecklist = {};
          document.querySelectorAll(`input[type="checkbox"][data-id="${id}"]`).forEach(cb => {
            if (cb.checked) selectedChecklist[cb.dataset.item] = true;
          });
          const notes = document.querySelector(`textarea[data-id="${id}"][data-item="Others"]`)?.value || "";

          updates.push(
            db.collection("return_requests").doc(id).update({
              status: sel.value,
              checklist: selectedChecklist,
              notes: notes,
              reviewedAt: new Date()
            })
          );
        }
      });
      if (updates.length === 0) return alert("ℹ No actions selected.");
      await Promise.all(updates);
      alert("✅ Changes applied!");
    });
  </script>
</body>
</html>
