<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>⚡ YANA Admin — Pending Approvals</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root {
  --bg:#0a0f12; --bg2:rgba(255,255,255,0.05); --border:rgba(255,255,255,0.12);
  --action:#00eaff; --text:#eaf4f8; --radius:14px; --transition:0.2s;
}
body {
  margin:0; font-family:'Inter',sans-serif; color:var(--text);
  background:linear-gradient(180deg,#061219 0%,#07131a 100%);
}
.navbar {
  display:flex; justify-content:space-between; align-items:center;
  padding:12px 20px; background:var(--bg2); border-bottom:1px solid var(--border);
  position: sticky; top:0; z-index:100; backdrop-filter: blur(6px);
}
.navbar h2 { color:var(--action); font-size:1.1rem; margin:0; }
.profile { display:flex; align-items:center; gap:10px; cursor:pointer; position:relative; }
.profile-pic { background:var(--action); color:#000; font-weight:700; width:38px; height:38px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:16px; }
.dropdown { display:none; position:absolute; top:46px; right:0; background:var(--bg2); border-radius:10px; padding:6px 0; min-width:140px; box-shadow:0 6px 18px rgba(0,0,0,0.6); }
.dropdown button { width:100%; background:none; border:none; color: var(--text); padding:10px 14px; cursor:pointer; text-align:left; font-weight:600; }
.profile:hover .dropdown { display:block; }
.container { padding:20px; max-width:1000px; margin:auto; }
.tabs { display:flex; gap:8px; margin-bottom:12px; }
.tab { padding:8px 16px; border-radius:var(--radius); background:var(--bg2); cursor:pointer; }
.tab.active { background:var(--action); color:#000; font-weight:bold; }
.card {
  background:var(--bg2); border:1px solid var(--border); border-radius:var(--radius); padding:12px; margin-bottom:12px;
  display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; cursor:pointer; transition:var(--transition);
}
.card:hover { border-color:var(--action); box-shadow:0 0 10px var(--action); }
.card-left { flex:1; min-width:220px; }
.card-right { display:flex; align-items:center; gap:8px; }
select { padding:6px; border-radius:var(--radius); border:1px solid var(--border); background:var(--bg2); color:var(--text); }
#searchBar { width:100%; padding:8px 12px; border-radius:var(--radius); margin-bottom:12px; border:1px solid var(--border); background:var(--bg2); color:var(--text); box-sizing:border-box; }
#submitBtn { float:right; padding:10px 16px; border:none; border-radius:var(--radius); background:var(--action); color:#000; cursor:pointer; font-weight:700; margin-top:12px; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:200; }
.modal-content { background:var(--bg2); padding:20px; border-radius:var(--radius); max-width:500px; width:90%; max-height:90%; overflow-y:auto; }
.modal h3 { margin-top:0; color:var(--action); }
.checklist-row { display:flex; align-items:center; gap:8px; margin:6px 0; }
.checklist-row input { width:auto; transform:scale(1.1); }
.checklist-row label { flex:1; }
button.closeModal { float:right; background:none; border:none; font-size:18px; color:var(--text); cursor:pointer; }
</style>
</head>
<body>

<div class="navbar">
  <h2>⚡ YANA Admin — Pending Approvals</h2>
  <div class="profile">
    <div class="profile-pic">A</div>
    <div class="dropdown">
      <button onclick="location.href='admin-dashboard.html'">⬅ Dashboard</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="tabs">
    <div class="tab active" id="riderTab">Rider Approvals</div>
    <div class="tab" id="rentalTab">Rental Requests</div>
  </div>

  <input type="text" id="searchBar" placeholder="Search by email, scooty id, name, plan...">

  <div id="riderContainer"></div>
  <div id="rentalContainer" style="display:none;"></div>

  <button id="submitBtn">Submit Changes</button>
</div>

<!-- Checklist Modal -->
<div class="modal" id="checklistModal">
  <div class="modal-content">
    <button class="closeModal" onclick="closeChecklist()">&times;</button>
    <h3>Vehicle Checklist</h3>
    <div id="checklistItems"></div>
    <button id="saveChecklist" class="btn" style="margin-top:12px;">Submit Checklist</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>
<script>
const riderContainer = document.getElementById("riderContainer");
const rentalContainer = document.getElementById("rentalContainer");
const checklistModal = document.getElementById("checklistModal");
const checklistItemsDiv = document.getElementById("checklistItems");
let pendingRiders = [], pendingRentals = [];
let activeTab = "riders";
let currentChecklistRental = null;

// Tabs
document.getElementById("riderTab").onclick = () => {
  activeTab = "riders";
  document.getElementById("riderTab").classList.add("active");
  document.getElementById("rentalTab").classList.remove("active");
  riderContainer.style.display = "block";
  rentalContainer.style.display = "none";
};
document.getElementById("rentalTab").onclick = () => {
  activeTab = "rentals";
  document.getElementById("rentalTab").classList.add("active");
  document.getElementById("riderTab").classList.remove("active");
  riderContainer.style.display = "none";
  rentalContainer.style.display = "block";
};

// Auth check
auth.onAuthStateChanged(async user => {
  if(!user) return location.href="admin-signin.html";
  document.querySelector(".profile-pic").innerText = (user.email[0]||"A").toUpperCase();
  const doc = await db.collection("users").doc(user.email).get();
  if(!doc.exists || !["admin","captain"].includes(doc.data().role)) {
    alert("❌ Access denied"); return location.href="index.html";
  }
  loadPendingRiders();
  loadPendingRentals();
});

document.getElementById("logoutBtn").onclick = () => auth.signOut();

// Riders
function loadPendingRiders(){
  db.collection("users").where("status","==","pending").onSnapshot(snapshot=>{
    pendingRiders = [];
    riderContainer.innerHTML="";
    if(snapshot.empty){ riderContainer.innerHTML="<p>No pending riders.</p>"; return; }
    snapshot.forEach(doc=>{ let d=doc.data(); d.id=doc.id; pendingRiders.push(d); });
    renderRiderCards(pendingRiders);
  });
}
function renderRiderCards(list){
  riderContainer.innerHTML="";
  list.forEach(d=>{
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `<div class="card-left">
      <b>${d.name||""}</b><br>Email: ${d.email||""}<br>Vendor: ${d.vendor||""}<br>Partners: ${(d.partners||[]).join(", ")}
    </div>
    <div class="card-right">
      <select data-type="rider" data-id="${d.id}">
        <option value="none" selected>No Action</option>
        <option value="approved">Approve</option>
        <option value="rejected">Reject</option>
      </select>
    </div>`;
    riderContainer.appendChild(card);
  });
}

// Rentals
function loadPendingRentals(){
  db.collection("rental_requests").where("status","==","pending").onSnapshot(snapshot=>{
    pendingRentals=[];
    rentalContainer.innerHTML="";
    if(snapshot.empty){ rentalContainer.innerHTML="<p>No pending rentals.</p>"; return; }
    snapshot.forEach(doc=>{ let d=doc.data(); d.id=doc.id; pendingRentals.push(d); });
    renderRentalCards(pendingRentals);
  });
}

function renderRentalCards(list){
  rentalContainer.innerHTML="";
  list.forEach(d=>{
    const lastAssigned = d.lastAssignedAt ? new Date(d.lastAssignedAt.seconds*1000) : new Date();
    const planDays = d.plan==="1d"?1:d.plan==="7d"?7:d.plan==="30d"?30:0;
    const dueDate = new Date(lastAssigned.getTime()+planDays*24*60*60*1000);
    const today = new Date();
    const excessDays = Math.max(0,Math.ceil((today-dueDate)/(1000*60*60*24)));
    const card = document.createElement("div");
    card.className="card";
    card.innerHTML = `<div class="card-left">
      <b>${d.email}</b><br>
      Scooty: ${d.scootyId||""}<br>
      Plan: ${d.plan||""} | Amount: ₹${d.amount||0}<br>
      Security Deposit: ₹${d.depositSelected?d.depositAmount||3000:"0"}<br>
      Due Date: ${dueDate.toLocaleDateString()} | Excess Days: ${excessDays}
    </div>
    <div class="card-right">
      <select data-type="rental" data-id="${d.id}">
        <option value="none" selected>No Action</option>
        <option value="approved">Approve</option>
        <option value="rejected">Reject</option>
      </select>
    </div>`;
    card.onclick = e=>{
      if(e.target.tagName==="SELECT") return;
      openChecklist(d);
    };
    rentalContainer.appendChild(card);
  });
}

// Checklist
const checklistFields = [
  "Nuts & Bolts","Headlight","Backlight","Tyres & Rims","Fan","Number plates","Phone Stand",
  "Foot rest","Side stand","Brake levers","Motor","Battery Health","Scratches","Paint loss","Others Specify"
];

function openChecklist(rental){
  currentChecklistRental = rental;
  checklistItemsDiv.innerHTML="";
  checklistFields.forEach(f=>{
    const row = document.createElement("div");
    row.className="checklist-row";
    row.innerHTML=`<input type="checkbox" value="${f}" id="chk-${f}"><label for="chk-${f}">${f}</label>`;
    checklistItemsDiv.appendChild(row);
  });
  checklistModal.style.display="flex";
}
function closeChecklist(){ checklistModal.style.display="none"; currentChecklistRental=null; }

document.getElementById("saveChecklist").onclick=async()=>{
  if(!currentChecklistRental) return;
  const checkedParts = Array.from(document.querySelectorAll("#checklistItems input:checked")).map(i=>i.value);
  try{
    await db.collection("return_requests").add({
      email: currentChecklistRental.email,
      scootyId: currentChecklistRental.scootyId,
      partsChecked: checkedParts,
      checkedBy: auth.currentUser.email,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("✅ Checklist submitted");
    closeChecklist();
  }catch(e){ console.error(e); alert("Failed: "+e.message); }
};

// Search
document.getElementById("searchBar").addEventListener("input", e=>{
  const term = e.target.value.toLowerCase();
  if(activeTab==="riders"){
    renderRiderCards(pendingRiders.filter(d=> 
      (d.name||"").toLowerCase().includes(term) || 
      (d.email||"").toLowerCase().includes(term) || 
      (d.vendor||"").toLowerCase().includes(term) ||
      (d.partners||[]).join(", ").toLowerCase().includes(term)
    ));
  } else {
    renderRentalCards(pendingRentals.filter(d=>
      (d.email||"").toLowerCase().includes(term) ||
      (d.scootyId||"").toLowerCase().includes(term) ||
      (d.plan||"").toLowerCase().includes(term)
    ));
  }
});

// Submit changes
document.getElementById("submitBtn").addEventListener("click", async ()=>{
  const selects = document.querySelectorAll("select[data-id]");
  for(let sel of selects){
    const type = sel.dataset.type, id = sel.dataset.id, val = sel.value;
    if(val==="none") continue;
    try{
      if(type==="rider"){
        await db.collection("users").doc(id).update({
          status: val,
          approvedBy: val==="approved"?auth.currentUser.email:null,
          approvedAt: val==="approved"?firebase.firestore.FieldValue.serverTimestamp():null
        });
        await db.collection("logs").add({email:id, action:"rider_"+val, timestamp:firebase.firestore.FieldValue.serverTimestamp()});
      } else if(type==="rental"){
        const reqRef = db.collection("rental_requests").doc(id);
        const reqSnap = await reqRef.get();
        if(!reqSnap.exists) continue;
        const req = reqSnap.data();
        if(val==="rejected"){
          await reqRef.update({status:"rejected", rejectedBy:auth.currentUser.email, rejectedAt:firebase.firestore.FieldValue.serverTimestamp()});
          await db.collection("logs").add({email:req.email, action:"rental_rejected", requestId:id, timestamp:firebase.firestore.FieldValue.serverTimestamp()});
        } else if(val==="approved"){
          await reqRef.update({status:"approved", approvedBy:auth.currentUser.email, approvedAt:firebase.firestore.FieldValue.serverTimestamp()});
          await db.collection("scooty_master").doc(req.scootyId).update({status:"assigned", assignedTo:req.email, lastAssignedAt:firebase.firestore.FieldValue.serverTimestamp()});
          if(req.batteryId) await db.collection("battery_master").doc(req.batteryId).update({status:"assigned", assignedTo:req.email, lastAssignedAt:firebase.firestore.FieldValue.serverTimestamp()});
          const userUpdate = {scootyId:req.scootyId, rentalPlan:req.plan||null, rentalAmount:req.amount||0, lastAssignedAt:firebase.firestore.FieldValue.serverTimestamp()};
          if(req.batteryId) userUpdate.batteryId=req.batteryId;
          if(req.depositSelected) { userUpdate.securityDeposit=req.depositAmount||3000; userUpdate.securityDepositTimestamp=firebase.firestore.FieldValue.serverTimestamp(); }
          await db.collection("users").doc(req.email).set(userUpdate,{merge:true});
          await db.collection("logs").add({email:req.email,type:"scooty",id:req.scootyId,action:"assign_via_admin",plan:req.plan||null,amount:req.amount||0,depositAmount:req.depositSelected?req.depositAmount||3000:null,approvedBy:auth.currentUser.email,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
          if(req.batteryId) await db.collection("logs").add({email:req.email,type:"battery",id:req.batteryId,action:"assign_via_admin",approvedBy:auth.currentUser.email,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
        }
      }
    }catch(e){ console.error(e); alert("Failed to process "+type+" ID "+id+": "+e.message); }
  }
  alert("✅ All selected changes applied!");
});
</script>
</body>
</html>
