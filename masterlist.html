
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — Scooty & Battery Masterlist</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Navbar styles */
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 12px;
    }
    .navbar h2 { margin: 0; font-size: 18px; color: var(--action); }
    .profile { display: flex; align-items: center; gap: 8px; }
    .profile-pic {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--action); color: #000;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 14px;
    }
    .dropdown button {
      margin-left: 4px;
      padding: 4px 8px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
      cursor: pointer;
    }

    /* Tabs */
    .tabs { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    .tab-btn {
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      padding:8px 12px; cursor:pointer; transition:var(--transition); color:var(--text);
    }
    .tab-btn.active { background:var(--action); color:#000; }

    /* Tab content */
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* Search bar */
    .search-container {
      margin: 12px 0;
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      flex-wrap: wrap;
    }
    .search-container input {
      padding: 8px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
      flex: 1 1 250px;
    }

    /* Card container */
    .card-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-top: 16px; }
    .card {
      background: rgba(255,255,255,0.1);
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 150px;
      transition: var(--transition);
    }
    .card:hover { box-shadow: 0 0 12px var(--action); border-color: var(--action); }
    .card-header { font-weight: bold; font-size: 16px; margin-bottom: 6px; color: var(--action); }
    .card-row { font-size: 14px; margin: 2px 0; }
    select {
      padding: 4px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
      margin-right: 6px;
    }
    button.assignBtn {
      padding: 4px 8px;
      border-radius: var(--radius);
      border: none;
      background: var(--action);
      color: #000;
      cursor: pointer;
    }
  </style>
</head>
<body>
<!-- Navbar -->
<div class="navbar">
  <h2>⚡ YANA Admin</h2>
  <div class="profile">
    <div class="profile-pic">A</div>
    <div class="dropdown">
      <button onclick="location.href='admin-dashboard.html'">⬅ Dashboard</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</div>

<div class="container">
  <h1> Scooty & Battery Masterlist </h1>
  <p class="muted">Read-only view of all assets. Use the search bar to filter.</p>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab-btn active" data-tab="scootiesTab">Scooties</div>
    <div class="tab-btn" data-tab="batteriesTab">Batteries</div>
  </div>

  <!-- Scooties Tab -->
  <div class="tab-content active" id="scootiesTab">
    <div class="search-container">
      <input id="scootySearch" type="text" placeholder="Search by ID, Rider, or Captain">
    </div>
    <div id="scootyCards" class="card-container"></div>
  </div>

  <!-- Batteries Tab -->
  <div class="tab-content" id="batteriesTab">
    <div class="search-container">
      <input id="batterySearch" type="text" placeholder="Search by ID, Rider, or Captain">
    </div>
    <div id="batteryCards" class="card-container"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>
let captains = [];
let currentUserRole = "";
let currentUserEmail = "";

const scootyContainer = document.getElementById("scootyCards");
const batteryContainer = document.getElementById("batteryCards");
let scootyData = [], batteryData = [];

auth.onAuthStateChanged(async user => {
  if (!user) return location.href="admin-signin.html";
  currentUserEmail = user.email;
  document.querySelector(".profile-pic").innerText = (user.email[0] || "A").toUpperCase();

  const doc = await db.collection("users").doc(user.email).get();
  if (!doc.exists || (doc.data().role !== "admin" && doc.data().role !== "captain")) { 
    alert("❌ Not authorized."); 
    location.href="index.html"; 
  }
  currentUserRole = doc.data().role;

  // fetch captains
  const capSnap = await db.collection("users").where("role","==","captain").get();
  captains = capSnap.docs.map(d => ({ email: d.id, name: d.data().name || d.id }));

  // now load assets
  renderCards("scooty_master", scootyContainer, document.getElementById("scootySearch"));
  renderCards("battery_master", batteryContainer, document.getElementById("batterySearch"));
});

document.getElementById("logoutBtn").onclick = () => auth.signOut();

// Tab switching
const tabButtons = document.querySelectorAll(".tab-btn");
const tabContents = document.querySelectorAll(".tab-content");
tabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    tabContents.forEach(c => c.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

async function renderCards(collection, container, searchInput) {
  db.collection(collection).onSnapshot(async snapshot => {
    const tempData = [];
    for (const doc of snapshot.docs) {
      const data = doc.data();
      let assignedName = "-";
      let captainName = "-";
      const captainEmail = data.captainInCharge || null;

      if (data.assignedTo) {
        const userDoc = await db.collection("users").doc(data.assignedTo).get();
        if (userDoc.exists) assignedName = userDoc.data().name || "-";
      }
      if (captainEmail) {
        const capDoc = await db.collection("users").doc(captainEmail).get();
        if (capDoc.exists) captainName = capDoc.data().name || "-";
      }

      // Captains see only their own assets
      if (currentUserRole === "captain" && captainEmail !== currentUserEmail) continue;

      tempData.push({ 
        id: doc.id, state: data.state, status: data.status, 
        assignedName, captainName, captainInCharge: captainEmail 
      });
    }
    if (collection === "scooty_master") scootyData = tempData;
    else batteryData = tempData;

    displayCards(tempData, container, searchInput.value, collection);
  });
}

function displayCards(dataArray, container, filter, collection) {
  container.innerHTML = "";
  const filterLower = filter.trim().toLowerCase();
  dataArray.filter(d => 
    d.id.toLowerCase().includes(filterLower) ||
    d.assignedName.toLowerCase().includes(filterLower) ||
    d.captainName.toLowerCase().includes(filterLower)
  ).forEach(d => {
      const card = document.createElement("div");
      card.classList.add("card");

      // Only admins see assign captain controls
      let captainOptionsHTML = "";
      let saveButtonHTML = "";
      if (currentUserRole === "admin") {
        let captainOptions = `<option value="">-- Select Captain --</option>`;
        captains.forEach(c => {
          captainOptions += `<option value="${c.email}" ${d.captainInCharge===c.email ? "selected" : ""}>${c.name}</option>`;
        });
        captainOptionsHTML = `<select id="cap-${collection}-${d.id}">${captainOptions}</select>`;
        saveButtonHTML = `<button class="assignBtn" onclick="assignCaptain('${collection}','${d.id}')">Save</button>`;
      }

      card.innerHTML = `
        <div class="card-header" style="color: var(--action)">${d.id}</div>
        <div class="card-row">Assigned To (Rider): ${d.assignedName}</div>
        <div class="card-row">Captain In Charge: ${d.captainName}</div>
        <div class="card-row">State: ${d.state}</div>
        <div class="card-row">Status: ${d.status}</div>
        <div class="card-row">
          ${captainOptionsHTML} ${saveButtonHTML}
        </div>
      `;
      container.appendChild(card);
  });
}

async function assignCaptain(collection, assetId) {
  const sel = document.getElementById(`cap-${collection}-${assetId}`);
  const chosen = sel.value;
  try {
    await db.collection(collection).doc(assetId).update({
      captainInCharge: chosen || null,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    });
    alert("✅ Captain assignment updated");
  } catch (e) {
    alert("❌ Failed to update: " + e.message);
  }
}

document.getElementById("scootySearch").addEventListener("input", e => {
  displayCards(scootyData, scootyContainer, e.target.value, "scooty_master");
});
document.getElementById("batterySearch").addEventListener("input", e => {
  displayCards(batteryData, batteryContainer, e.target.value, "battery_master");
});
</script>
</body>
</html>
