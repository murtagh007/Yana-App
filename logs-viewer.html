<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA â€” Logs Viewer</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: rgba(255,255,255,0.05);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
    }
    .navbar button { color: var(--text); background: var(--bg2); border: 1px solid var(--border); padding: 6px 12px; border-radius: var(--radius); cursor: pointer; }
    .container { padding: 16px; }
    h1 { margin-bottom: 8px; }
    .muted { color: rgba(255,255,255,0.5); margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; text-align: left; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    th { background: rgba(255,255,255,0.05); color: var(--action); }
    input, select, button { padding: 6px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg2); color: var(--text); }
    .filters { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-bottom: 12px; }
    .btn-small { padding: 6px 12px; font-size: 13px; }
  </style>
</head>
<body>
  <div class="navbar">
    <button onclick="location.href='admin-dashboard.html'">â¬… Dashboard</button>
    <span id="adminEmail"></span>
    <button id="logoutBtn">Logout</button>
  </div>

  <div class="container">
    <h1>ðŸ“œ Logs Viewer</h1>
    <p class="muted">View all state changes, status changes, and issue logs.</p>

    <div class="filters">
      <label>Filter:</label>
      <select id="logFilter">
        <option value="all">All</option>
        <option value="state-change">State-Change</option>
        <option value="status-change">Status-Change</option>
        <option value="issue-creation">Issue-Creation</option>
        <option value="issue-resolution">Issue-Resolution</option>
      </select>

      <label>Search by Asset ID:</label>
      <input type="text" id="searchInput" placeholder="e.g. SCOOTY002"/>

      <button class="btn-small" id="exportBtn">â¬‡ Export CSV</button>
    </div>

    <table id="logsTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>User</th>
          <th>Action</th>
          <th>Item Type</th>
          <th>Item ID</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const tbody = document.querySelector("#logsTable tbody");
    let allLogs = [];

    auth.onAuthStateChanged(async user => {
      if (!user) return location.href="admin-signin.html";
      document.getElementById("adminEmail").innerText = "ðŸ‘¤ " + user.email;

      const doc = await db.collection("users").doc(user.email).get();
      if (!doc.exists || doc.data().role !== "admin") {
        alert("âŒ Not an admin."); 
        return location.href="index.html";
      }

      loadLogs();
    });

    document.getElementById("logoutBtn").addEventListener("click", () => auth.signOut());

    async function loadLogs() {
      db.collection("logs").orderBy("timestamp","desc").onSnapshot(async snapshot => {
        const rawLogs = snapshot.docs.map(d => ({ id:d.id, ...d.data() }));
        const emails = Array.from(new Set(rawLogs.map(l=>l.email||l.user||l.admin).filter(Boolean)));
        
        const userMap = {};
        if (emails.length > 0) {
          const usersSnap = await db.collection("users").where(firebase.firestore.FieldPath.documentId(), "in", emails).get();
          usersSnap.forEach(u => userMap[u.id] = u.data().name || u.id);
        }

        allLogs = rawLogs.map(log => {
          const emailKey = log.email || log.user || log.admin || null;
          const userName = emailKey ? (userMap[emailKey] || emailKey) : "-";

          let actionLabel = "-";
          let details = "-";

          if (log.action === "state-change") {
            actionLabel = "State-Change";
            details = `State â†’ ${log.newState || "-"}`;
          } else if (["status-change","assigned","returned"].includes(log.action)) {
            actionLabel = "Status-Change";
            details = `Status â†’ ${log.status || log.action || "-"}`;
          } else if (log.action === "issue-creation") {
            actionLabel = "Issue-Creation";
            details = `Issue: ${log.issue || "-"}`;
          } else if (log.action === "issue-resolution" || log.status === "resolved") {
            actionLabel = "Issue-Resolution";
            details = `Resolved: ${log.issue || "-"}`;
          }

          const itemType = log.itemType || log.type || "-";
          const itemId = log.itemId || log.assetId || "-";

          return { timestamp: log.timestamp, userName, actionLabel, itemType, itemId, details };
        });

        renderLogs();
      });
    }

    function renderLogs() {
      const filter = document.getElementById("logFilter").value;
      const searchText = document.getElementById("searchInput").value.trim().toLowerCase();

      tbody.innerHTML = "";
      allLogs
        .filter(l => (filter==="all" || l.actionLabel.toLowerCase() === filter.toLowerCase()))
        .filter(l => !searchText || l.itemId.toLowerCase().includes(searchText))
        .forEach(l => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${l.timestamp?.toDate().toLocaleString() || "-"}</td>
            <td>${l.userName}</td>
            <td>${l.actionLabel}</td>
            <td>${l.itemType}</td>
            <td>${l.itemId}</td>
            <td>${l.details}</td>
          `;
          tbody.appendChild(tr);
        });
    }

    document.getElementById("logFilter").addEventListener("change", renderLogs);
    document.getElementById("searchInput").addEventListener("input", renderLogs);

    document.getElementById("exportBtn").addEventListener("click", () => {
      const logs = Array.from(tbody.querySelectorAll("tr")).map(tr => Array.from(tr.children).map(td => td.innerText));
      if (logs.length===0){ alert("âš ï¸ No logs to export."); return; }

      const csvContent = "data:text/csv;charset=utf-8," 
        + ["Time","User","Action","Item Type","Item ID","Details"].join(",") + "\n"
        + logs.map(r => r.map(v=>`"${v.replace(/"/g,'""')}"`).join(",")).join("\n");

      const link = document.createElement("a");
      link.setAttribute("href", encodeURI(csvContent));
      link.setAttribute("download", "logs_export.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
  </script>
</body>
</html>
