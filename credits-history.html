<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>YANA ‚Äî Credits History</title>

<link rel="stylesheet" href="styles.css">

<style>
.container { padding:14px }
table { width:100%; border-collapse:collapse; margin-top:10px }
th,td {
  border:1px solid rgba(255,255,255,0.15);
  padding:6px;
}
th { background:rgba(255,255,255,0.08) }
button { cursor:pointer }
</style>
</head>
<body>

<div class="navbar">
  <h2>‚ö° YANA Admin</h2>
  <div class="profile">
    <div class="profile-pic">A</div>
    <div class="dropdown">
      <button onclick="location.href='admin-dashboard.html'">‚¨Ö Dashboard</button>
      <button onclick="location.href='user-management.html'">Users</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</div>

<div class="container">
  <h2>Credits History</h2>

  <label>Filter by Email</label>
  <input id="filterEmail" placeholder="example@email.com">

  <button class="menu-btn ripple" onclick="loadLogs()">Search</button>

  <button class="menu-btn ripple" onclick="exportCSV()">üì§ Export to CSV</button>

  <table id="logsTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>Rider</th>
        <th>Days</th>
        <th>Reason</th>
        <th>Credited By</th>
        <th>Type</th>
        <th>Undo</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>
const tbody = document.querySelector("#logsTable tbody");

document.getElementById("logoutBtn").onclick = ()=>auth.signOut();

auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="admin-signin.html";

  const doc = await db.collection("users").doc(user.email).get();
  if(!doc.exists || doc.data().role!=="admin"){
    alert("Admins only");
    return location.href="index.html";
  }

  document.querySelector(".profile-pic").innerText =
    (user.email[0]||"A").toUpperCase();

  const presetEmail = new URLSearchParams(location.search).get("email");
  if(presetEmail) document.getElementById("filterEmail").value = presetEmail;

  loadLogs();
});

function loadLogs(){
  tbody.innerHTML = "";

  const email = document.getElementById("filterEmail").value.trim();
  let ref = db.collection("credits_logs").orderBy("timestamp","desc");

  if(email) ref = ref.where("email","==",email);

  ref.onSnapshot(snap=>{
    tbody.innerHTML = "";
    snap.forEach(d=>{
      const r = d.data();
      r.id = d.id;

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>${r.timestamp?.toDate?.()?.toLocaleString()||"-"}</td>
        <td>${r.email||"-"}</td>
        <td>${r.days||0}</td>
        <td>${r.reason||"-"}</td>
        <td>${r.creditedBy||"-"}</td>
        <td>${r.type||"-"}</td>
        <td>
          ${r.reverted
            ? "‚ùå Reverted"
            : `<button onclick="undoCredit('${r.id}','${r.email}',${r.days})">Undo</button>`
          }
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

async function undoCredit(logId,email,days){
  if(!confirm("Undo this credit?")) return;

  try{
    const userRef = db.collection("users").doc(email);
    const logRef  = db.collection("credits_logs").doc(logId);

    await db.runTransaction(async t=>{
      const userSnap = await t.get(userRef);
      const logSnap  = await t.get(logRef);

      if(!logSnap.exists || logSnap.data().reverted)
        throw new Error("Already reverted");

      let current = userSnap.exists ? (userSnap.data().creditedDays||0) : 0;
      let updated = Math.max(0, current - days);

      t.update(userRef,{ creditedDays: updated });

      t.update(logRef,{
        reverted:true,
        revertedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      t.set(db.collection("credits_logs").doc(),{
        email,
        days:-days,
        reason:"Undo credit",
        creditedBy: auth.currentUser.email,
        type:"undo",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    alert("Credit reverted.");
  }catch(e){
    alert("Failed: "+e.message);
  }
}

function exportCSV(){
  let rows=[["Time","Email","Days","Reason","Credited By","Type"]];
  document.querySelectorAll("#logsTable tbody tr").forEach(tr=>{
    rows.push([...tr.querySelectorAll("td")].map(td=>td.innerText));
  });

  const csvContent=rows.map(r=>r.join(",")).join("\n");
  const blob=new Blob([csvContent],{type:"text/csv;charset=utf-8;"});
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download="credits_history.csv";
  link.click();
}
</script>

</body>
</html>
