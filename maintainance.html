<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YANA â€” Scooty Maintenance & Usage</title>
<link rel="stylesheet" href="styles.css">
<style>
  body { font-family: system-ui, sans-serif; margin: 0; padding: 12px; background: #111; color: #eee; }
  .navbar { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #222; border-radius:8px; margin-bottom:12px; }
  .profile-pic { width:32px;height:32px;border-radius:50%;background:#0ff;color:#000;display:flex;align-items:center;justify-content:center;font-weight:bold; }
  table { width:100%; border-collapse: collapse; margin-top:12px; }
  th, td { border:1px solid #555; padding:8px; text-align:center; }
  th { background:#333; color:#0ff; }
  button { padding:6px 12px; margin:4px; border:none; border-radius:6px; background:#0ff; color:#000; cursor:pointer; }
</style>
</head>
<body>

<div class="navbar">
  <h2>âš¡ YANA â€” Scooty Maintenance & Usage</h2>
  <div class="profile">
    <div class="profile-pic">A</div>
    <button id="logoutBtn">Logout</button>
  </div>
</div>

<button id="refreshBtn">ðŸ”„ Refresh</button>
<button id="saveBtn">ðŸ’¾ Save computed dates to DB</button>

<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Assigned Rider</th>
      <th>Days Used</th>
      <th>Last Maintenance</th>
      <th>Next Maintenance</th>
      <th>Assigned Captain</th>
    </tr>
  </thead>
  <tbody id="scootyTableBody">
    <tr><td colspan="6">Loadingâ€¦</td></tr>
  </tbody>
</table>

<p style="margin-top:12px;font-size:12px;color:#888;">
Notes: Calculations use <code>logs</code> (action="state-change") if available. Fallbacks: <code>createdAt</code>/<code>updatedAt</code> from <code>scooty_master</code>. "Days Used" counts days between the first assignment after the last maintenance (or the first assignment ever) and the last return (or today if currently assigned).
</p>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>
const tableBody = document.getElementById("scootyTableBody");
let scootyData = [];

auth.onAuthStateChanged(async user => {
  if(!user) return location.href="admin-signin.html";
  document.querySelector(".profile-pic").innerText = (user.email[0] || "A").toUpperCase();
  await loadScooties();
});

document.getElementById("logoutBtn").onclick = () => auth.signOut();
document.getElementById("refreshBtn").onclick = () => loadScooties();
document.getElementById("saveBtn").onclick = () => saveComputedDates();

async function loadScooties() {
  tableBody.innerHTML = '<tr><td colspan="6">Loadingâ€¦</td></tr>';
  const snapshot = await db.collection("scooty_master").get();
  scootyData = [];
  for(const doc of snapshot.docs){
    const d = doc.data();
    const scootyId = doc.id;
    let assignedRider = d.assignedTo || "-";
    let assignedCaptain = d.captainInCharge || "-";
    let createdAt = d.createdAt?.toDate() || new Date();
    let updatedAt = d.updatedAt?.toDate() || createdAt;

    // Fetch logs for this scooty
    const logsSnap = await db.collection("logs")
      .where("itemId","==",scootyId)
      .where("action","==","state-change")
      .orderBy("timestamp")
      .get();

    let lastMaintenance = null;
    let firstAssignmentAfterMaintenance = null;
    let lastReturnDate = null;
    
    logsSnap.docs.forEach(log => {
      const data = log.data();
      const ts = data.timestamp?.toDate();
      if(data.newState === "maintenance" || data.newState === "repair"){
        lastMaintenance = ts;
      }
      if(data.newState === "active" && !firstAssignmentAfterMaintenance){
        firstAssignmentAfterMaintenance = ts;
      }
      if(data.status === "returned" || data.newState === "returned"){
        lastReturnDate = ts;
      }
    });

    if(!lastMaintenance) lastMaintenance = createdAt;
    if(!firstAssignmentAfterMaintenance) firstAssignmentAfterMaintenance = lastMaintenance || createdAt;
    if(!lastReturnDate) lastReturnDate = updatedAt || new Date();

    const daysUsed = Math.ceil((lastReturnDate - firstAssignmentAfterMaintenance)/(1000*60*60*24));
    const nextMaintenance = new Date(lastMaintenance.getTime() + 15*24*60*60*1000);

    scootyData.push({
      id: scootyId,
      assignedRider,
      assignedCaptain,
      daysUsed,
      lastMaintenance: lastMaintenance.toLocaleDateString(),
      nextMaintenance: nextMaintenance.toLocaleDateString()
    });
  }

  displayTable();
}

function displayTable() {
  if(scootyData.length === 0){
    tableBody.innerHTML = '<tr><td colspan="6">No scooties found</td></tr>';
    return;
  }
  tableBody.innerHTML = "";
  scootyData.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${d.id}</td>
      <td>${d.assignedRider}</td>
      <td>${d.daysUsed}</td>
      <td>${d.lastMaintenance}</td>
      <td>${d.nextMaintenance}</td>
      <td>${d.assignedCaptain}</td>`;
    tableBody.appendChild(tr);
  });
}

async function saveComputedDates() {
  for(const d of scootyData){
    await db.collection("scooty_master").doc(d.id).update({
      lastMaintenanceDate: new Date(d.lastMaintenance),
      nextMaintenanceDate: new Date(d.nextMaintenance),
      daysUsed: d.daysUsed
    });
  }
  alert("âœ… Computed dates saved to database!");
}
</script>
</body>
</html>
