<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scooty — Maintenance & Usage</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #f5f5f5; }
  </style>
</head>
<body>
  <h2>Scooty — Maintenance & Usage</h2>
  <p>Shows Assigned Rider, Days Used, Last / Next Maintenance and Assigned Captain.</p>
  <button onclick="loadScooties()">Refresh</button>
  <button onclick="saveComputed()">Save computed dates to DB</button>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Assigned To</th>
        <th>Days Used</th>
        <th>Last Maintenance</th>
        <th>Next Maintenance</th>
        <th>Assigned Captain</th>
      </tr>
    </thead>
    <tbody id="scootyTableBody">
      <tr><td colspan="6">Loading…</td></tr>
    </tbody>
  </table>

  <p style="font-size:12px; color:#666;">
    Notes: Calculations use `logs` (action="state-change") if available.  
    Fallbacks: `createdAt` / `updatedAt` from scooty_master.  
    "Days Used" counts days between the first assignment after the last maintenance (or the first assignment ever) and the last return (or today if currently assigned).
  </p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadScooties() {
      const tbody = document.getElementById("scootyTableBody");
      tbody.innerHTML = ""; // clear Loading…

      try {
        const snapshot = await getDocs(collection(db, "scooty_master"));
        if (snapshot.empty) {
          tbody.innerHTML = "<tr><td colspan='6'>No scooties found</td></tr>";
          return;
        }

        snapshot.forEach(async (doc) => {
          try {
            const data = doc.data();
            console.log("Processing scooty:", doc.id, data);

            // Assigned To
            const assignedTo = data.assignedTo || "—";

            // Captain
            const captain = data.captainInCharge || "—";

            // Maintenance dates
            const lastMaint = data.lastMaintenance?.toDate?.() || data.updatedAt?.toDate?.() || null;
            const nextMaint = data.nextMaintenance?.toDate?.() || null;

            // Days Used
            let daysUsed = "—";
            try {
              const logsQ = query(
                collection(db, "logs"),
                where("scootyId", "==", doc.id),
                where("action", "==", "state-change")
              );
              const logsSnap = await getDocs(logsQ);

              if (!logsSnap.empty) {
                const events = logsSnap.docs.map(l => l.data());
                const firstAssign = events.find(e => e.newState === "active")?.timestamp?.toDate?.();
                const lastReturn = events.find(e => e.newState === "returned")?.timestamp?.toDate?.();

                if (firstAssign) {
                  const endDate = lastReturn || new Date();
                  daysUsed = Math.ceil((endDate - firstAssign) / (1000 * 60 * 60 * 24));
                }
              } else if (data.createdAt?.toDate) {
                const start = data.createdAt.toDate();
                const end = data.updatedAt?.toDate?.() || new Date();
                daysUsed = Math.ceil((end - start) / (1000 * 60 * 60 * 24));
              }
            } catch (err) {
              console.error("Error calculating daysUsed for", doc.id, err);
            }

            const row = `
              <tr>
                <td>${doc.id}</td>
                <td>${assignedTo}</td>
                <td>${daysUsed}</td>
                <td>${lastMaint ? lastMaint.toLocaleDateString() : "—"}</td>
                <td>${nextMaint ? nextMaint.toLocaleDateString() : "—"}</td>
                <td>${captain}</td>
              </tr>
            `;
            tbody.insertAdjacentHTML("beforeend", row);
          } catch (err) {
            console.error("Error rendering row for scooty", doc.id, err);
          }
        });
      } catch (err) {
        console.error("Error loading scooties:", err);
        tbody.innerHTML = "<tr><td colspan='6'>Error loading scooties</td></tr>";
      }
    }

    function saveComputed() {
      alert("Save-to-DB not implemented yet.");
    }

    // Initial load
    loadScooties();
  </script>
</body>
</html>
