<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YANA — Scooty Maintenance & Usage</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body { font-family: Arial, sans-serif; background:#111; color:#eaf4f8; margin:0; padding:0; }
.navbar { display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:#1a1a1a; }
.navbar h2 { margin:0; color:#00eaff; }
.navbar .profile { display:flex; align-items:center; gap:8px; }
.profile-pic { width:32px;height:32px;border-radius:50%;background:#00eaff;color:#000;display:flex;align-items:center;justify-content:center;font-weight:bold; }
.dropdown button { margin-left:4px;padding:4px 8px;border-radius:5px;border:none;background:#222;color:#eaf4f8;cursor:pointer; }
.container { padding:12px; }
table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { border:1px solid #555; padding:8px; text-align:left; }
th { background:#00eaff; color:#000; }
button { padding:6px 12px; border:none; border-radius:5px; background:#00eaff; color:#000; cursor:pointer; margin-right:6px; }
.muted { font-size:12px; color:#888; margin-top:6px; }
</style>
</head>
<body>

<div class="navbar">
  <h2>⚡ YANA Scooty Maintenance</h2>
  <div class="profile">
    <div class="profile-pic" id="profilePic">A</div>
    <div class="dropdown">
      <button onclick="location.href='admin-dashboard.html'">⬅ Dashboard</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</div>

<div class="container">
  <button id="refreshBtn">Refresh</button>
  <button id="saveBtn">Save Computed Dates to DB</button>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Assigned To</th>
        <th>Days Used</th>
        <th>Last Maintenance</th>
        <th>Next Maintenance</th>
        <th>Assigned Captain</th>
      </tr>
    </thead>
    <tbody id="scootyTable">
      <tr><td colspan="6">Loading…</td></tr>
    </tbody>
  </table>

  <p class="muted">
    Notes: Days Used = (last <code>returned</code> log after maintenance OR today) − (first <code>assigned</code> log after maintenance OR first assignment ever).
    Next Maintenance = last maintenance/repair + 15 days (or first assignment + 15 if none).
  </p>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>
const tableBody = document.getElementById("scootyTable");
let scootyList = [];

auth.onAuthStateChanged(async user => {
  if (!user) location.href="admin-signin.html";
  document.getElementById("profilePic").innerText = user.email[0].toUpperCase();
  loadScooties();
});

document.getElementById("logoutBtn").onclick = () => auth.signOut();
document.getElementById("refreshBtn").onclick = loadScooties;
document.getElementById("saveBtn").onclick = saveToDB;

async function loadScooties() {
  tableBody.innerHTML = "<tr><td colspan='6'>Loading…</td></tr>";

  const scootySnap = await db.collection("scooty_master").get();
  const logSnap = await db.collection("logs").get();

  // Organize logs by scooty
  const logs = {};
  logSnap.docs.forEach(d => {
    const data = d.data();
    if (data.itemType !== "scooty") return;
    if (!logs[data.itemId]) logs[data.itemId] = [];
    logs[data.itemId].push({ ...data, timestamp: data.timestamp.toDate() });
  });

  scootyList = [];
  scootySnap.docs.forEach(doc => {
    const data = doc.data();
    const scootyId = doc.id;
    const scootyLogs = logs[scootyId] || [];

    // Find last maintenance/repair date
    let lastMaint = null;
    scootyLogs.forEach(l => {
      if (l.action === "state-change" && (l.newState === "maintenance" || l.newState === "repair")) {
        if (!lastMaint || l.timestamp > lastMaint) lastMaint = l.timestamp;
      }
    });

    // Find first assignment after maintenance (or ever)
    let startDate = null;
    scootyLogs.filter(l => l.action === "assigned")
      .sort((a, b) => a.timestamp - b.timestamp)
      .forEach(l => {
        if (!lastMaint || l.timestamp > lastMaint) {
          if (!startDate) startDate = l.timestamp;
        }
      });
    if (!startDate && data.createdAt) {
      startDate = data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt.seconds*1000);
    }

    // Find most recent return after startDate
    let endDate = null;
    scootyLogs.filter(l => l.action === "returned" && (!startDate || l.timestamp >= startDate))
      .forEach(l => {
        if (!endDate || l.timestamp > endDate) endDate = l.timestamp;
      });
    if (!endDate) endDate = new Date();

    // Days used
    let daysUsed = (startDate && endDate) ? Math.ceil((endDate - startDate)/(1000*60*60*24)) : 0;

    // Next maintenance
    let nextMaint = lastMaint
      ? new Date(lastMaint.getTime() + 15*24*60*60*1000)
      : (startDate ? new Date(startDate.getTime() + 15*24*60*60*1000) : null);

    scootyList.push({
      id: scootyId,
      assignedTo: data.assignedTo || "-",
      daysUsed,
      lastMaintenance: lastMaint ? lastMaint.toLocaleDateString() : "-",
      nextMaintenance: nextMaint ? nextMaint.toLocaleDateString() : "-",
      captain: data.captainInCharge || "-"
    });
  });

  renderTable();
}

function renderTable() {
  if(scootyList.length === 0) {
    tableBody.innerHTML = "<tr><td colspan='6'>No scooties found</td></tr>";
    return;
  }
  tableBody.innerHTML = "";
  scootyList.forEach(s => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.id}</td>
      <td>${s.assignedTo}</td>
      <td>${s.daysUsed}</td>
      <td>${s.lastMaintenance}</td>
      <td>${s.nextMaintenance}</td>
      <td>${s.captain}</td>
    `;
    tableBody.appendChild(tr);
  });
}

async function saveToDB() {
  for (const s of scootyList) {
    await db.collection("scooty_master").doc(s.id).update({
      lastMaintenanceDate: s.lastMaintenance,
      nextMaintenanceDate: s.nextMaintenance,
      daysUsed: s.daysUsed
    });
  }
  alert("✅ Computed dates saved to DB");
}
</script>

</body>
</html>
