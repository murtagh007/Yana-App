<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YANA ‚Äî Scooty Maintenance & Usage</title>
<link rel="stylesheet" href="styles.css">
<style>
body { font-family: sans-serif; background:#0a0f12; color:#eaf4f8; }
table { width:100%; border-collapse: collapse; margin-top: 12px; }
th, td { border:1px solid #333; padding:6px 8px; text-align:center; }
th { background: #111; color:#00eaff; }
.muted { font-size: 13px; color:#888; margin-top:4px; }
.container { max-width:1200px; margin:auto; padding:12px; }
button { padding:6px 12px; border-radius:4px; border:none; background:#00eaff; color:#000; cursor:pointer; }
</style>
</head>
<body>

<div class="container">
  <h1>‚ö° Scooty ‚Äî Maintenance & Usage</h1>
  <div>
    <button id="refreshBtn">üîÑ Refresh</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Assigned Rider</th>
        <th>Days Used</th>
        <th>Last Maintenance</th>
        <th>Next Maintenance</th>
        <th>Assigned Captain</th>
      </tr>
    </thead>
    <tbody id="scootyTableBody">
      <tr><td colspan="6">Loading‚Ä¶</td></tr>
    </tbody>
  </table>
  <p class="muted">
    Notes: Calculations use <code>logs</code> (action="state-change") if available. Fallbacks: <code>createdAt</code> / <code>updatedAt</code> from <code>scooty_master</code>. "Days Used" counts days between the first assignment after the last maintenance (or first assignment ever) and the last return (or today if currently assigned).
  </p>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>
const tableBody = document.getElementById("scootyTableBody");

let currentUserRole = "";
let currentUserEmail = "";

// Auth check
auth.onAuthStateChanged(async user => {
  if (!user) return location.href="admin-signin.html";
  currentUserEmail = user.email;
  const doc = await db.collection("users").doc(user.email).get();
  if (!doc.exists || !["admin","captain"].includes(doc.data().role)) {
    alert("‚ùå Not authorized."); 
    return location.href="index.html";
  }
  currentUserRole = doc.data().role;
  loadScooties();
});

document.getElementById("refreshBtn").addEventListener("click", loadScooties);

async function loadScooties() {
  tableBody.innerHTML = `<tr><td colspan="6">Loading‚Ä¶</td></tr>`;

  try {
    const scootySnap = await db.collection("scooty_master").get();
    const logsSnap = await db.collection("logs")
      .where("action","==","state-change")
      .orderBy("timestamp")
      .get();

    const logsMap = {};
    logsSnap.docs.forEach(doc => {
      const log = doc.data();
      const ts = log.timestamp ? log.timestamp.toDate() : new Date();
      if(!logsMap[log.itemId]) logsMap[log.itemId] = [];
      logsMap[log.itemId].push({...log, timestamp: ts});
    });

    const rows = [];

    scootySnap.docs.forEach(doc => {
      const data = doc.data();
      if(currentUserRole==="captain" && data.captainInCharge!==currentUserEmail) return;

      const createdAt = data.createdAt ? data.createdAt.toDate() : new Date();
      const updatedAt = data.updatedAt ? data.updatedAt.toDate() : createdAt;
      const assignedRider = data.assignedTo || "-";
      const captain = data.captainInCharge || "-";

      const logs = logsMap[doc.id] || [];

      // Filter maintenance/repair logs
      const maintLogs = logs.filter(l => l.newState==="maintenance" || l.newState==="repair");
      const lastMaint = maintLogs.length>0 ? maintLogs[maintLogs.length-1].timestamp : null;
      const lastMaintDisplay = lastMaint ? lastMaint.toLocaleDateString() : "-";

      const nextMaint = lastMaint ? new Date(lastMaint.getTime() + 15*24*60*60*1000) : 
                        (createdAt ? new Date(createdAt.getTime() + 15*24*60*60*1000) : "-");
      const nextMaintDisplay = nextMaint instanceof Date ? nextMaint.toLocaleDateString() : "-";

      // Days Used calculation
      let firstAssignDate = createdAt;
      const postMaintLogs = logs.filter(l => l.newState==="active" && l.timestamp > (lastMaint||createdAt));
      if(postMaintLogs.length>0) firstAssignDate = postMaintLogs[0].timestamp;

      // Find last return
      const returnLogs = logs.filter(l => l.newState==="returned");
      const lastReturn = returnLogs.length>0 ? returnLogs[returnLogs.length-1].timestamp : new Date();

      const daysUsed = Math.ceil((lastReturn-firstAssignDate)/(1000*60*60*24));

      rows.push(`
        <tr>
          <td>${doc.id}</td>
          <td>${assignedRider}</td>
          <td>${daysUsed}</td>
          <td>${lastMaintDisplay}</td>
          <td>${nextMaintDisplay}</td>
          <td>${captain}</td>
        </tr>
      `);
    });

    tableBody.innerHTML = rows.length>0 ? rows.join("") : `<tr><td colspan="6">No scooties found</td></tr>`;
  } catch(e) {
    console.error(e);
    tableBody.innerHTML = `<tr><td colspan="6">Error loading scooties</td></tr>`;
  }
}
</script>
</body>
</html>
