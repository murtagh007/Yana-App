<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA â€” Rider Dashboard</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root {
      --bg: #0a0f12;
      --card: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.2);
      --action: #00eaff;
      --text: #eaf4f8;
      --radius: 16px;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(270deg,var(--bg),#141a1f,var(--bg));
      background-size: 600% 600%;
      animation: gradientShift 20s ease infinite;
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    @keyframes gradientShift {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    /* Navbar */
    .navbar {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      background: linear-gradient(135deg, #00eaff, #0066ff);
      border-radius: 0 0 20px 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-weight: bold;
      color: #fff;
      font-size: 1.2rem;
    }

    /* Container */
    .container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
    }

    /* Card */
    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 20px;
      padding: 24px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    h1 {
      font-size: 22px;
      font-weight: 700;
      color: var(--action);
      margin-bottom: 16px;
      text-align: center;
    }

    .info-block {
      background: rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: inset 0 0 6px rgba(0,0,0,0.2);
      position: relative;
    }

    .info-block i {
      font-size: 24px;
      color: var(--action);
      margin-bottom: 6px;
    }

    .info-label {
      font-size: 14px;
      color: #aaa;
    }

    .info-value {
      font-size: 20px;
      font-weight: bold;
      margin-top: 4px;
    }

    /* Buttons */
    .btn {
      background: linear-gradient(90deg, #00eaff, #00ffaa);
      border-radius: 50px;
      padding: 14px 0;
      font-weight: 700;
      color: #000;
      border: none;
      cursor: pointer;
      flex: 1;
      transition: all 0.3s ease;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,234,255,0.4); }
    .btn.secondary {
      background: rgba(0,0,0,0.2);
      color: var(--action);
      border: 2px solid var(--action);
    }

    /* Buttons container */
    .btn-group { display: flex; gap: 10px; margin: 12px 0; }

    /* Scooty/Battery Block */
    .status {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .status-box {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 12px 16px;
      text-align: center;
      font-weight: 500;
      color: var(--text);
      box-shadow: inset 0 0 6px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0,0,0,0.25);
      border-radius: 24px 24px 0 0;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.4);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      backdrop-filter: blur(6px);
      z-index: 1000;
    }
    .bottom-nav a {
      color: var(--text);
      text-decoration: none;
      text-align: center;
      flex: 1;
      font-size: 12px;
      transition: all 0.2s;
    }
    .bottom-nav a i {
      display: block;
      font-size: 18px;
      margin-bottom: 2px;
      color: var(--action);
    }
    .bottom-nav a.active i {
      transform: scale(1.2);
      text-shadow: 0 0 6px #00eaff;
    }

    @media(max-width:480px){
      .card { padding: 16px; }
      .info-value { font-size: 18px; }
      h1 { font-size: 20px; }
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">âš¡ YANA Rider</div>

  <!-- Main Card -->
  <div class="container">
    <div class="card">
      <h1>Work Tracker</h1>

      <!-- Working Hours -->
      <div class="info-block">
        <i class="fa-solid fa-clock"></i>
        <div class="info-label">Working Hours</div>
        <div class="info-value" id="workTimer">00:00:00</div>
      </div>

      <!-- Break Time -->
      <div class="info-block">
        <i class="fa-solid fa-bed"></i>
        <div class="info-label">Total Break Time</div>
        <div class="info-value" id="breakTime">00h : 00m</div>
      </div>

      <!-- Assigned Shift -->
      <div class="info-block">
        <i class="fa-solid fa-calendar-day"></i>
        <div class="info-label">Assigned Shift</div>
        <div class="info-value" id="shiftTiming">09:00 AM â€“ 06:00 PM</div>
      </div>

      <!-- Punch / Break Buttons -->
      <div class="btn-group">
        <button class="btn" id="punchBtn">Press to Punch In</button>
        <button class="btn secondary" id="breakBtn">Start Break</button>
      </div>

      <!-- Scooty / Battery -->
      <div class="status">
        <div class="status-box">ðŸ›µ Scooty: <span id="currentScooty">Loading...</span></div>
        <div class="status-box">ðŸ”‹ Battery: <span id="currentBattery">Loading...</span></div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <a href="rider-dashboard.html" class="active"><i class="fa-solid fa-house"></i>Home</a>
    <a href="scanner.html"><i class="fa-solid fa-qrcode"></i>Scanner</a>
    <a href="issue.html"><i class="fa-solid fa-triangle-exclamation"></i>Issues</a>
    <a href="attendance.html"><i class="fa-solid fa-user-check"></i>Attendance</a>
    <a href="rider-logs.html"><i class="fa-solid fa-file-lines"></i>Logs</a>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const email = params.get("email");

    let punchedIn = false;
    let onBreak = false;
    let workSeconds = 0;
    let breakSeconds = 0;
    let timerInterval, breakInterval;

    const punchBtn = document.getElementById("punchBtn");
    const breakBtn = document.getElementById("breakBtn");
    const timerDisplay = document.getElementById("workTimer");
    const breakDisplay = document.getElementById("breakTime");

    // Timer updates
    function updateTimer() {
      workSeconds++;
      const hrs = String(Math.floor(workSeconds / 3600)).padStart(2,'0');
      const mins = String(Math.floor((workSeconds % 3600) / 60)).padStart(2,'0');
      const secs = String(workSeconds % 60).padStart(2,'0');
      timerDisplay.textContent = `${hrs}:${mins}:${secs}`;
    }
    function updateBreakTimer() {
      breakSeconds++;
      const hrs = String(Math.floor(breakSeconds / 3600)).padStart(2,'0');
      const mins = String(Math.floor((breakSeconds % 3600) / 60)).padStart(2,'0');
      breakDisplay.textContent = `${hrs}h : ${mins}m`;
    }

    // Haversine distance
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2-lat1) * Math.PI/180;
      const dLon = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    async function isInsideLocation(lat, lng) {
      const locs = await db.collection("locations").get();
      let inside = null;
      locs.forEach(doc=>{
        const d = doc.data();
        const dist = getDistanceFromLatLonInKm(lat,lng,d.lat,d.lng)*1000;
        if(dist<=d.radius) inside=d;
      });
      return inside;
    }

    // Punch In/Out
    punchBtn.addEventListener("click", ()=>{
      if(!navigator.geolocation){ alert("âŒ Geolocation not supported."); return; }

      navigator.geolocation.getCurrentPosition(async pos=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const inside = await isInsideLocation(lat,lng);

        if(!inside){ alert("âŒ You are outside allowed attendance zones."); return; }

        if(!punchedIn){
          punchedIn=true;
          punchBtn.textContent="Press to Punch Out";
          timerInterval=setInterval(updateTimer,1000);

          await db.collection("attendance").add({
            rider: email,
            type:"punch_in",
            location:inside.name,
            lat,lng,
            timestamp:firebase.firestore.FieldValue.serverTimestamp()
          });
        }else{
          punchedIn=false;
          punchBtn.textContent="Press to Punch In";
          clearInterval(timerInterval);

          await db.collection("attendance").add({
            rider: email,
            type:"punch_out",
            location:inside.name,
            lat,lng,
            workSeconds,
            breakSeconds,
            timestamp:firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      },err=>{ alert("âŒ Location error: "+err.message); });
    });

    // Break button
    breakBtn.addEventListener("click", ()=>{
      if(!punchedIn){ alert("âš ï¸ You must Punch In before starting a break."); return; }

      if(!onBreak){
        onBreak=true;
        breakBtn.textContent="End Break";
        clearInterval(timerInterval);
        breakInterval=setInterval(updateBreakTimer,60*1000);

        db.collection("attendance").add({
          rider:email,
          type:"break_start",
          timestamp:firebase.firestore.FieldValue.serverTimestamp()
        });
      }else{
        onBreak=false;
        breakBtn.textContent="Start Break";
        clearInterval(breakInterval);
        timerInterval=setInterval(updateTimer,1000);

        db.collection("attendance").add({
          rider:email,
          type:"break_end",
          timestamp:firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    });

    // Load scooty/battery
    async function loadAssignments(){
      const s = await db.collection("scooty_master").where("assignedTo","==",email).where("status","==","assigned").limit(1).get();
      s.forEach(d=>document.getElementById("currentScooty").innerText=d.id || "None");

      const b = await db.collection("battery_master").where("assignedTo","==",email).where("status","==","assigned").limit(1).get();
      b.forEach(d=>document.getElementById("currentBattery").innerText=d.id || "None");
    }
    loadAssignments();
  </script>
</body>
</html>
