<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>YANA — Rider Dashboard</title>
  <link rel="stylesheet" href="styles.css">

  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- Your Firebase config -->
  <script src="firebase-config.js"></script>
</head>
<body>
  <div class="card">
    <h1>🚴 Rider Dashboard</h1>

    <!-- Rider Info -->
    <div id="riderInfo" class="muted"></div>

    <!-- Current assignment -->
    <div class="status">
      <h2>Current Assignment</h2>
      <p>Scooty: <span id="currentScooty">Loading...</span></p>
      <p>Battery: <span id="currentBattery">Loading...</span></p>
    </div>

    <!-- Timer section -->
    <div class="timers">
      <h2>Work Timer</h2>
      <p><span id="workValue">00:00:00</span></p>
      <h2>Break Timer</h2>
      <p><span id="breakValue">00:00:00</span></p>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn" id="scanBtn">📷 Scan QR</button>
      <button class="btn" id="logsBtn">📜 Rider Logs</button>
      <button class="btn" id="issueBtn">⚠️ Raise Issue</button>
      <button class="btn" id="punchBtn">👊 Punch In</button>
      <button class="btn" id="breakBtn">☕ Start Break</button>
      <button class="btn secondary" id="logoutBtn">🚪 Logout</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
  (async function init(){ 
    if(typeof firebase === 'undefined' || typeof db === 'undefined'){
      alert("Firebase not configured. Make sure firebase-config.js sets `db = firebase.firestore();`");
      return;
    }

    try { await firebase.firestore().enablePersistence(); } catch(e) { }

    const toast = (msg)=>{ const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2500); };
    const pad=(n)=>String(n).padStart(2,'0');
    const format=(s)=>`${pad(Math.floor(s/3600))}:${pad(Math.floor((s%3600)/60))}:${pad(s%60)}`;

    const params = new URLSearchParams(window.location.search);
    const email = params.get("email");
    if(!email){
      alert("Not signed in!");
      window.location.href="rider-signin.html";
      return;
    }

    const riderInfoDiv = document.getElementById("riderInfo");
    const workValue = document.getElementById("workValue");
    const breakValue = document.getElementById("breakValue");
    const punchBtn = document.getElementById("punchBtn");
    const breakBtn = document.getElementById("breakBtn");

    let currentScooty = null;
    let currentBattery = null;

    let workTicker=null, breakTicker=null, unsubStateListener=null;
    let localState = { punchedIn:false, workingSeconds:0, onBreak:false, totalBreakSeconds:0, punchInTime:null, breakStartTime:null };

    const stateDocRef = ()=>db.collection("attendance").doc(email);

    function saveLocal(){
      localStorage.setItem("attendance_"+email, JSON.stringify(localState));
    }

    function loadLocal(){
      try{
        const d = JSON.parse(localStorage.getItem("attendance_"+email));
        if(d) localState = d;
      }catch(e){}
    }
    loadLocal();

    function stopTickers(){ 
      if(workTicker){ clearInterval(workTicker); workTicker=null; } 
      if(breakTicker){ clearInterval(breakTicker); breakTicker=null; } 
    }

    // ✅ Recalculate timers based on timestamps
    function startTickers(){
      stopTickers();
      if(localState.punchedIn && localState.punchInTime){
        workTicker = setInterval(()=>{
          let elapsed = Math.floor((Date.now() - localState.punchInTime)/1000);
          let work = elapsed - (localState.totalBreakSeconds||0);
          workValue.innerText = format(Math.max(work,0));
        },1000);
      } else {
        workValue.innerText = format(localState.workingSeconds||0);
      }

      if(localState.onBreak && localState.breakStartTime){
        breakTicker = setInterval(()=>{
          let elapsed = Math.floor((Date.now() - localState.breakStartTime)/1000);
          let b = (localState.totalBreakSeconds||0) + elapsed;
          breakValue.innerText = format(Math.max(b,0));
        },1000);
      } else {
        breakValue.innerText = format(localState.totalBreakSeconds||0);
      }
    }

    async function attachStateListener(){
      if(unsubStateListener) { unsubStateListener(); unsubStateListener=null; }
      const ref = stateDocRef();
      unsubStateListener = ref.onSnapshot(async snap=>{
        if(!snap.exists) return;
        const data = snap.data();
        localState.punchedIn = !!data.punchedIn;
        localState.workingSeconds = Number(data.workingSeconds || 0);
        localState.onBreak = !!data.onBreak;
        localState.totalBreakSeconds = Number(data.totalBreakSeconds || 0);
        localState.punchInTime = data.punchInTime ? data.punchInTime.toMillis() : null;
        localState.breakStartTime = data.breakStartTime ? data.breakStartTime.toMillis() : null;
        saveLocal();

        // ✅ Auto punch-out at 2 AM
        if(localState.punchedIn && localState.punchInTime){
          const punchDate = new Date(localState.punchInTime);
          const resetTime = new Date(punchDate);
          resetTime.setHours(2,0,0,0); 
          if(Date.now() > resetTime.getTime()){
            await ref.set({
              punchedIn:false,
              onBreak:false,
              punchInTime:null,
              breakStartTime:null,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, {merge:true});
            toast("⏰ Auto Punch-Out at 2 AM");
            return;
          }
        }

        startTickers();
        updateUI();
      }, err=>{ console.warn("state listener error",err); });
    }

    function updateUI(){
      if(localState.punchedIn){
        punchBtn.innerText = "🔚 Punch Out";
        breakBtn.style.display = "inline-block";
        breakBtn.innerText = localState.onBreak? "🔄 End Break" : "☕ Start Break";
      } else {
        punchBtn.innerText = "👊 Punch In";
        breakBtn.style.display = "none";
      }
    }

    async function punchToggle(){
      const ref = stateDocRef();
      if(!localState.punchedIn){
        await ref.set({
          punchedIn:true,
          onBreak:false,
          workingSeconds:0,
          totalBreakSeconds:0,
          punchInTime: firebase.firestore.Timestamp.now(),
          breakStartTime:null,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        toast("Punched In");
      } else {
        await ref.set({
          punchedIn:false,
          onBreak:false,
          punchInTime:null,
          breakStartTime:null,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        toast("Punched Out");
      }
    }

    async function breakToggle(){
      const ref = stateDocRef();
      if(!localState.onBreak){
        await ref.set({
          onBreak:true,
          breakStartTime: firebase.firestore.Timestamp.now(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        toast("Break Started");
      } else {
        let add = Math.floor((Date.now() - localState.breakStartTime)/1000);
        await ref.set({
          onBreak:false,
          breakStartTime:null,
          totalBreakSeconds:(localState.totalBreakSeconds||0)+add,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
        toast("Break Ended");
      }
    }

    punchBtn.addEventListener("click", punchToggle);
    breakBtn.addEventListener("click", breakToggle);

    document.getElementById("scanBtn").addEventListener("click", () => {
      window.location.href = `scanner.html?email=${email}`;
    });
    document.getElementById("logsBtn").addEventListener("click", () => {
      window.location.href = `rider-logs.html?email=${email}`;
    });
    document.getElementById("issueBtn").addEventListener("click", () => {
      window.location.href = `issue.html?email=${email}`;
    });
    document.getElementById("logoutBtn").addEventListener("click", () => {
      firebase.auth().signOut().then(()=>{
        window.location.href="rider-signin.html";
      });
    });

    async function loadRider(){
      const doc = await db.collection("users").doc(email).get();
      if(!doc.exists){
        alert("Rider not found.");
        window.location.href="rider-signup.html";
        return;
      }
      const data = doc.data();
      riderInfoDiv.innerHTML = `<b>${data.name}</b> (${email}) — Status: ${data.status}`;
      if(data.status !== "approved"){
        alert("Your account is not approved.");
        window.location.href="rider-signin.html";
        return;
      }
      loadMyAssignments();
    }

    async function loadMyAssignments(){
      currentScooty = null;
      currentBattery = null;

      const s = await db.collection("scooty_master")
        .where("assignedTo", "==", email)
        .where("status", "==", "assigned")
        .limit(1).get();
      s.forEach(d => currentScooty = d.id);

      const b = await db.collection("battery_master")
        .where("assignedTo", "==", email)
        .where("status", "==", "assigned")
        .limit(1).get();
      b.forEach(d => currentBattery = d.id);

      document.getElementById("currentScooty").innerText = currentScooty || "None";
      document.getElementById("currentBattery").innerText = currentBattery || "None";
    }

    loadRider();
    attachStateListener();
    updateUI();

  })();
  </script>
</body>
</html>
