<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YANA â€” Rider Dashboard</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{
  --bg:#071014; --card: rgba(255,255,255,0.06); --border: rgba(255,255,255,0.12);
  --accent:#00eaff; --text:#eaf4f8; --r:16px;
}
body{margin:0;font-family:Inter,Arial;background:#061014;color:var(--text);}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.header h1{margin:0;font-size:1rem;color:var(--accent)}
.container{padding:14px;display:flex;justify-content:center}
.card{position:relative;width:92vw;max-width:520px;background:var(--card);border-radius:var(--r);padding:18px;border:1px solid var(--border)}
.title{font-size:1.2rem;color:var(--accent);margin-bottom:8px}
.timerRow{display:flex;gap:12px;justify-content:center;align-items:center}
.block{flex:1;background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;border:1px solid var(--border);text-align:center}
.block .label{font-size:0.9rem;color:#bcd;margin-bottom:6px}
.block .value{font-size:1.6rem;font-weight:700}
.controls{display:flex;gap:10px;margin-top:14px}
.btn{flex:1;padding:12px;border-radius:12px;border:none;font-weight:700;cursor:pointer;background:var(--accent);color:#000;display:flex;align-items:center;justify-content:center;gap:6px}
.btn.secondary{background:transparent;color:var(--accent);border:2px solid var(--accent);padding:6px 10px;font-size:0.85rem}
.info{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
.info .pill{flex:1;padding:10px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid var(--border);text-align:center}
.bottomNav{position:fixed;left:0;right:0;bottom:0;padding:10px;background:var(--card);display:flex;justify-content:space-around;border-top:1px solid var(--border)}
.navBtn{color:var(--text);font-size:0.85rem;cursor:pointer;display:flex;flex-direction:column;align-items:center}

/* Circular Timer */
#rentalTimerContainer{position:absolute;top:12px;right:12px;width:60px;height:60px;transform:scale(0.5);}
#rentalTimerSvg{transform: rotate(-90deg);}
#rentalProgressCircle{transition: stroke-dashoffset 0.5s linear; transform: rotate(0deg);}
#rentalTimerText{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:0.6rem;font-weight:700;color:var(--accent);text-align:center;}
</style>
</head>
<body>

<div class="header">
  <h1>âš¡ YANA Rider</h1>
  <button id="logoutBtn" class="btn secondary">Logout</button>
</div>

<div class="container">
  <div class="card">
    <div class="title">Rider Dashboard</div>
    <div id="riderName">Loading...</div>

    <!-- Rental Timer Top Right -->
    <div id="rentalTimerContainer">
      <svg id="rentalTimerSvg" width="120" height="120">
        <circle cx="60" cy="60" r="70" stroke="rgba(255,255,255,0.1)" stroke-width="10" fill="none"/>
        <circle id="rentalProgressCircle" cx="60" cy="60" r="70" stroke="var(--accent)" stroke-width="10" fill="none" stroke-dasharray="439.82" stroke-dashoffset="0"/>
      </svg>
      <div id="rentalTimerText">--:--:--:--</div>
    </div>

    <div class="timerRow">
      <div class="block">
        <div class="label">Working Hours</div>
        <div id="workValue" class="value">00:00:00</div>
      </div>
      <div class="block">
        <div class="label">Break Time</div>
        <div id="breakValue" class="value">00:00:00</div>
      </div>
    </div>

    <div class="controls">
      <button id="punchBtn" class="btn"><i class="fa-solid fa-clock"></i><span id="punchLabel">Punch In</span></button>
      <button id="breakBtn" class="btn secondary"><i class="fa-solid fa-coffee"></i><span id="breakLabel">Start Break</span></button>
    </div>

    <div class="info">
      <div class="pill">Scooty: <strong id="scooty">--</strong></div>
      <div class="pill">Battery: <strong id="battery">--</strong></div>
    </div>
    <div style="margin-top:8px;font-size:0.85rem" id="statusLine">Status: --</div>
    <div style="margin-top:2px;font-size:0.75rem;color:#bcd" id="dueDateLine">Due Date: --</div>
  </div>
</div>

<div class="bottomNav">
  <div class="navBtn" id="navScanner"><i class="fa-solid fa-qrcode"></i><div>Scanner</div></div>
  <div class="navBtn" id="navIssues"><i class="fa-solid fa-triangle-exclamation"></i><div>Issues</div></div>
  <div class="navBtn" id="navAttendance"><i class="fa-solid fa-user-check"></i><div>Attendance</div></div>
  <div class="navBtn" id="navLogs"><i class="fa-solid fa-file-lines"></i><div>Logs</div></div>
</div>

<script>
(async function(){
  if(typeof firebase==='undefined' || typeof db==='undefined'){ alert("Firebase not configured"); return; }

  const email = new URLSearchParams(window.location.search).get('email');
  if(!email){ location.href="rider-signin.html"; return; }

  const workValue=document.getElementById("workValue"), breakValue=document.getElementById("breakValue");
  const punchLabel=document.getElementById("punchLabel"), breakLabel=document.getElementById("breakLabel");
  const statusLine=document.getElementById("statusLine");
  const dueDateLine=document.getElementById("dueDateLine");
  const rentalProgressCircle=document.getElementById("rentalProgressCircle");
  const rentalTimerText=document.getElementById("rentalTimerText");

  const pad=n=>String(n).padStart(2,"0");

  // ðŸ”¹ Rental Timer Logic (Cumulative days)
  let rentalStartTime=0, rentalEndTime=0;
  let totalPlanDays=0;

  async function loadRentalData(){
    const rentalSnap=await db.collection("rental_requests")
      .where("email","==",email)
      .where("status","==","approved")
      .orderBy("timestamp")
      .get();

    if(rentalSnap.empty) return;

    let cumulativeDays=0;
    rentalSnap.docs.forEach(doc=>{
      const data=doc.data();
      const planDays=parseInt(data.plan.replace('d',''));
      cumulativeDays+=planDays;
    });

    // Add previous pausedDays + rentalPlan from users
    const userSnap=await db.collection("users").doc(email).get();
    if(userSnap.exists){
      const userData=userSnap.data();
      cumulativeDays += (userData.rentalPlan||0) + (userData.pausedDays||0);
      document.getElementById("riderName").innerText = `${userData.name} (${email})`;
    }

    const lastRental = rentalSnap.docs[rentalSnap.docs.length-1].data();
    const startTime = lastRental.timestamp.toDate();
    rentalStartTime=startTime.getTime();
    const today=new Date();
    const elapsedDays=Math.floor((today.getTime()-rentalStartTime)/(1000*60*60*24));
    const remainingDays=cumulativeDays - elapsedDays;
    rentalEndTime = rentalStartTime + cumulativeDays*24*60*60*1000;

    dueDateLine.innerText=`Due Date: ${new Date(rentalEndTime).toLocaleDateString()}`;

    // Update circular timer
    setInterval(()=>{
      const now=Date.now();
      let remaining = Math.max(rentalEndTime-now,0);
      let days=Math.floor(remaining/(1000*60*60*24));
      let hours=Math.floor((remaining%(1000*60*60*24))/(1000*60*60));
      let minutes=Math.floor((remaining%(1000*60*60))/(1000*60));
      let seconds=Math.floor((remaining%(1000*60))/1000);
      rentalTimerText.innerText=`${days}d\n${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

      const totalDuration=rentalEndTime-rentalStartTime;
      let dashOffset=439.82*(1-remaining/totalDuration);
      rentalProgressCircle.setAttribute("stroke-dashoffset", dashOffset);
    },1000);
  }

  await loadRentalData();

  // ðŸ”¹ Attendance / Break Logic (kept as before)
  const stateRef = ()=> db.collection("attendance").doc(`${email}_${new Date().toISOString().slice(0,10)}_state`);
  let state = { punchedIn:false, punchInTime:null, workingSeconds:0, onBreak:false, breakStartTime:null, totalBreakSeconds:0 };

  function computeTimes(){
    const now=Date.now();
    let workSecs=state.workingSeconds;
    if(state.punchedIn && state.punchInTime && !state.onBreak){ workSecs += Math.floor((now - state.punchInTime)/1000); }
    let breakSecs=state.totalBreakSeconds;
    if(state.onBreak && state.breakStartTime){ breakSecs += Math.floor((now - state.breakStartTime)/1000); }
    return {workSecs, breakSecs};
  }

  function updateUI(){
    const {workSecs, breakSecs}=computeTimes();
    workValue.innerText=`${pad(Math.floor(workSecs/3600))}:${pad(Math.floor((workSecs%3600)/60))}:${pad(workSecs%60)}`;
    breakValue.innerText=`${pad(Math.floor(breakSecs/3600))}:${pad(Math.floor((breakSecs%3600)/60))}:${pad(breakSecs%60)}`;
    statusLine.innerText=`Status: ${state.onBreak?"On Break":(state.punchedIn?"Working":"Idle")}`;
    dueDateLine.style.display="block";
  }

  setInterval(updateUI,1000);

  // ðŸ”¹ Scooty & Battery Real-time
  db.collection("scooty_master")
    .where("assignedTo","==",email)
    .where("state","==","active")
    .onSnapshot(snap=>{ document.getElementById("scooty").innerText = !snap.empty?snap.docs.map(d=>d.id).join(", "):"--"; });

  db.collection("battery_master")
    .where("assignedTo","==",email)
    .where("state","==","active")
    .onSnapshot(snap=>{ document.getElementById("battery").innerText = !snap.empty?snap.docs.map(d=>d.id).join(", "):"--"; });

  document.getElementById("navScanner").onclick=()=>location.href=`scanner.html?email=${email}`;
  document.getElementById("navIssues").onclick=()=>location.href=`issue.html?email=${email}`;
  document.getElementById("navAttendance").onclick=()=>location.href=`rider-dashboard.html?email=${email}`;
  document.getElementById("navLogs").onclick=()=>location.href=`rider-logs.html?email=${email}`;
  document.getElementById("logoutBtn").addEventListener("click",()=>{ firebase.auth().signOut(); location.href="rider-signin.html"; });

})();
</script>
</body>
</html>
