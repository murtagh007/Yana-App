<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YANA — Rider Dashboard</title>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<style>
  body{font-family:sans-serif;margin:0;background:#f9f9f9;color:#333;}
  header{background:#0066cc;color:#fff;padding:1rem;text-align:center;}
  main{padding:1rem;}
  .card{background:#fff;padding:1rem;margin-bottom:1rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
  .timer{font-size:1.2rem;margin-top:.5rem;}
  .progress-circle{width:120px;height:120px;}
  .progress-bg{stroke:#eee;stroke-width:10;fill:none;}
  .progress-bar{stroke:#0066cc;stroke-width:10;fill:none;stroke-linecap:round;transform:rotate(-90deg);transform-origin:50% 50%;}
</style>
</head>
<body>
<header><h1>Rider Dashboard</h1></header>
<main>
  <div class="card">
    <h2>Rental Timer</h2>
    <svg class="progress-circle">
      <circle class="progress-bg" cx="60" cy="60" r="54"/>
      <circle id="rentalProgress" class="progress-bar" cx="60" cy="60" r="54" stroke-dasharray="339.292" stroke-dashoffset="339.292"/>
    </svg>
    <div id="rentalTimerText" class="timer">--d 00:00:00</div>
    <div id="dueLine" style="font-size:.9rem;color:#666;"></div>
  </div>
</main>

<script>
  // Firebase config
  const firebaseConfig={ /* your config */ };
  firebase.initializeApp(firebaseConfig);
  const db=firebase.firestore();
  const auth=firebase.auth();

  const rentalProgress=document.getElementById('rentalProgress');
  const rentalTimerText=document.getElementById('rentalTimerText');
  const dueLine=document.getElementById('dueLine');
  const CIRCUMFERENCE=2*Math.PI*54;
  rentalProgress.style.strokeDasharray=String(CIRCUMFERENCE);
  rentalProgress.style.strokeDashoffset=String(CIRCUMFERENCE);

  let rentalIntervalId=null;
  let rentalStartMs=null;
  let rentalTotalSeconds=0;

  function pad(n){return n.toString().padStart(2,'0');}
  function parsePlanToDays(plan){ 
    if(!plan) return 0; 
    if(typeof plan==="string" && plan.endsWith("d")) return parseInt(plan); 
    return parseInt(plan)||0; 
  }

  async function refreshRentalTimerSources(scootyId){
    if(rentalIntervalId){ clearInterval(rentalIntervalId); rentalIntervalId=null; }

    const email=auth.currentUser?.email;
    if(!email) return;

    const userSnap = await db.collection('users').doc(email).get();
    const userData = userSnap.exists? userSnap.data() : {};

    // latest approved rental_request
    const rentSnap = await db.collection('rental_requests')
        .where('scootyId','==',scootyId)
        .where('email','==',email)
        .orderBy('approvedAt','desc')
        .limit(1).get();
    let rentalDoc = rentSnap.empty ? null : rentSnap.docs[0].data();

    // check rental_history for carryOverTime
    const historySnap = await db.collection('rental_history')
        .where('scootyID','==',scootyId)
        .where('riderEmail','==',email)
        .orderBy('approvedAt','desc')
        .limit(1).get();
    let carryOverTime = 0;
    if(!historySnap.empty){
      const histDoc = historySnap.docs[0];
      const histData = histDoc.data();
      carryOverTime = parseInt(histData.carryOverTime)||0;

      // ✅ reset carryOverTime in the old history record
      if(carryOverTime>0){
        await histDoc.ref.update({carryOverTime:0});
      }
    }

    // use approvedAt timestamp
    let startMs = rentalDoc?.approvedAt?.toMillis() || Date.now();
    let totalDays = parsePlanToDays(rentalDoc?.plan) 
                  + parsePlanToDays(userData.rentalPlan) 
                  + parsePlanToDays(userData.pausedDays) 
                  + carryOverTime;

    if(!rentalDoc || totalDays<=0){
      rentalTimerText.innerText='--d 00:00:00';
      rentalProgress.style.strokeDashoffset=String(CIRCUMFERENCE);
      dueLine.innerText='';
      return;
    }

    rentalStartMs=startMs;
    rentalTotalSeconds = totalDays*24*3600;
    const dueDate = new Date(rentalStartMs + rentalTotalSeconds*1000);
    dueLine.innerText = `Due: ${dueDate.toLocaleDateString()} — Remaining below`;

    function tick(){
      const now=Date.now();
      let elapsed = Math.floor((now-rentalStartMs)/1000);

      // check if scooty is returned
      db.collection('scooty_master').doc(scootyId).get().then(doc=>{
        if(doc.exists && doc.data().state==='inactive'){
          elapsed = Math.min(elapsed,rentalTotalSeconds); // freeze progress
        }
      });

      let remaining = Math.max(0,rentalTotalSeconds-elapsed);
      const days = Math.floor(remaining/86400);
      const hms = remaining%86400;
      const hours = Math.floor(hms/3600);
      const minutes = Math.floor((hms%3600)/60);
      const seconds = hms%60;
      rentalTimerText.innerText = `${days}d ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
      rentalProgress.style.strokeDashoffset = CIRCUMFERENCE*(1-remaining/rentalTotalSeconds);
    }
    tick();
    rentalIntervalId = setInterval(tick,1000);
  }

  // Example: after login, call refreshRentalTimerSources('S001')
  auth.onAuthStateChanged(user=>{
    if(user){
      // Replace with actual scootyId from your assignment logic
      refreshRentalTimerSources('S001');
    }
  });
</script>
</body>
</html>
