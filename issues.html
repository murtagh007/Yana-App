<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YANA — Issues Viewer</title>
<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  .navbar { display:flex; align-items:center; justify-content:space-between; padding:12px 20px; background: var(--card); border-bottom:1px solid var(--border); }
  .navbar h2 { color: var(--action); margin:0; }
  .profile { display:flex; align-items:center; gap:12px; }
  .profile-pic { background: var(--action); color:#fff; font-weight:bold; width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; }

  .container { padding:20px; }
  table { width:100%; border-collapse:collapse; margin-top:12px; background: rgba(255,255,255,0.05); border-radius: var(--radius); overflow:hidden; }
  th, td { padding:8px; font-size:14px; border-bottom:1px solid rgba(255,255,255,0.1); }
  th { background-color: var(--action); color:#fff; text-align:left; }
  td { color: var(--text); }
  .filters { display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px; align-items:center; }
  .filters input, .filters select { padding:6px 10px; border-radius: var(--radius); border:1px solid var(--border); background: var(--bg2); color: var(--text); }
  .filters button { padding:6px 12px; border-radius: var(--radius); border:none; background: var(--action); color:#fff; cursor:pointer; }
  .pagination { display:flex; gap:6px; margin-top:12px; align-items:center; }
  .pagination button { padding:4px 10px; border-radius: var(--radius); border:1px solid var(--border); background: var(--bg2); color: var(--text); cursor:pointer; }
  .pagination button.active { background: var(--action); color:#fff; }
</style>
</head>
<body>
<div class="navbar">
  <h2>⚡ YANA Issues Viewer</h2>
  <div class="profile"><div class="profile-pic">A</div></div>
</div>

<div class="container">
  <h1>🛠 Issues Viewer</h1>
  <p class="muted">View all issues and their resolutions.</p>

  <div class="filters">
    <label>Status:</label>
    <select id="issueFilter">
      <option value="all">All</option>
      <option value="open">Open</option>
      <option value="resolved">Resolved</option>
    </select>

    <label>Search by Asset ID:</label>
    <input type="text" id="searchInput" placeholder="e.g. SCOOTY001">

    <label>Start Date:</label>
    <input type="date" id="startDate">
    <label>End Date:</label>
    <input type="date" id="endDate">

    <button id="exportBtn">⬇ Export CSV</button>
  </div>

  <table id="issuesTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        <th>Status</th>
        <th>Type</th>
        <th>Asset ID</th>
        <th>Issue</th>
        <th>Captain</th>
        <th>Actions</th> <!-- ✅ Added -->
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination" id="pagination"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>
const tbody = document.querySelector("#issuesTable tbody");
const paginationEl = document.getElementById("pagination");
let allLogs = [], userRole = "", userEmail = "";
const itemsPerPage = 10;
let currentPage = 1;

function normalizeName(name) {
  return name ? name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ') : "-";
}

function filterLogs() {
  const filter = document.getElementById("issueFilter").value;
  const searchText = document.getElementById("searchInput").value.trim().toLowerCase();
  const start = document.getElementById("startDate").value ? new Date(document.getElementById("startDate").value) : null;
  const end = document.getElementById("endDate").value ? new Date(document.getElementById("endDate").value) : null;

  return allLogs.filter(log => {
    if(userRole === "captain" && log.captainInCharge !== userEmail) return false;
    if(filter !== "all" && filter !== log.status) return false;
    if(searchText && !(log.assetId||"").toLowerCase().includes(searchText)) return false;
    if(start && log.createdAt?.toDate() < start) return false;
    if(end && log.createdAt?.toDate() > end) return false;
    return true;
  });
}

function renderLogsPage(page=1) {
  const filtered = filterLogs();
  currentPage = page;
  const startIndex = (page-1)*itemsPerPage;
  const pageItems = filtered.slice(startIndex, startIndex + itemsPerPage);

  tbody.innerHTML = "";
  pageItems.forEach(log => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${log.createdAt?.toDate().toLocaleString() || "-"}</td>
      <td>${normalizeName(log.email)}</td>
      <td>${log.status || "-"}</td>
      <td>${log.type || "-"}</td>
      <td>${log.assetId || "-"}</td>
      <td>${log.issue || "-"}</td>
      <td>${log.captainInCharge || "-"}</td>
      <td>
        ${log.status === "open" ? `<button onclick="resolveIssue('${log.id}','${log.assetId}')">Resolve</button>` : "-"}
      </td>
    `;
    tbody.appendChild(tr);
  });

  renderPagination(filtered.length);
}

function renderPagination(totalItems) {
  paginationEl.innerHTML = "";
  const totalPages = Math.ceil(totalItems/itemsPerPage);
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement("button");
    btn.innerText = i;
    if(i===currentPage) btn.classList.add("active");
    btn.onclick = () => renderLogsPage(i);
    paginationEl.appendChild(btn);
  }
}

// ✅ Resolve issue only if asset state != "active"
async function resolveIssue(issueId, assetId) {
  try {
    const scootyRef = db.collection("scooty_master").doc(assetId);
    const scootyDoc = await scootyRef.get();
    if (!scootyDoc.exists) {
      alert("⚠️ Asset not found.");
      return;
    }

    const state = scootyDoc.data().state;
    if (state === "active") {
      alert("⚠️ Cannot resolve issue while the scooty is ACTIVE. Change its state first.");
      return;
    }

    await db.collection("issues").doc(issueId).update({
      status: "resolved",
      resolvedAt: new Date(),
      resolvedBy: userEmail
    });
    alert("✅ Issue resolved successfully.");
  } catch (err) {
    console.error("Error resolving issue:", err);
    alert("❌ Failed to resolve issue.");
  }
}

document.getElementById("issueFilter").addEventListener("change", () => renderLogsPage(1));
document.getElementById("searchInput").addEventListener("input", () => renderLogsPage(1));
document.getElementById("startDate").addEventListener("change", () => renderLogsPage(1));
document.getElementById("endDate").addEventListener("change", () => renderLogsPage(1));

document.getElementById("exportBtn").addEventListener("click", () => {
  const logs = filterLogs();
  if(!logs.length){ alert("⚠️ No issues to export."); return; }
  const headers = ["Time","User","Status","Type","Asset ID","Issue","Captain"];
  const rows = logs.map(log => [
    log.createdAt?.toDate().toLocaleString()||"-",
    normalizeName(log.email),
    log.status||"-",
    log.type||"-",
    log.assetId||"-",
    log.issue||"-",
    log.captainInCharge||"-"
  ]);
  let csvContent = "data:text/csv;charset=utf-8," 
    + headers.join(",") + "\n"
    + rows.map(r => r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const link = document.createElement("a");
  link.setAttribute("href", encodeURI(csvContent));
  link.setAttribute("download","issues_export.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
});

auth.onAuthStateChanged(async user=>{
  if(!user) { location.href="admin-signin.html"; return; }
  const doc = await db.collection("users").doc(user.email).get();
  if(!doc.exists || !["admin","captain"].includes(doc.data().role)) { alert("❌ Not authorized"); location.href="index.html"; return; }

  userRole = doc.data().role;
  userEmail = user.email;
  document.querySelector(".profile-pic").innerText = (doc.data().name ? doc.data().name[0] : user.email[0]).toUpperCase();

  db.collection("issues").orderBy("createdAt","desc").onSnapshot(snapshot=>{
    allLogs = snapshot.docs.map(d=>({ id:d.id, ...d.data() }));
    renderLogsPage(1);
  });
});
</script>
</body>
</html>
