<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>YANA â€” User Management</title>

<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
.card{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);
border-radius:var(--radius);padding:12px;margin-bottom:12px;display:flex;
justify-content:space-between;align-items:center;flex-wrap:wrap}
.card-right{display:flex;gap:6px;flex-wrap:wrap}
input,select{padding:6px;border-radius:8px}
.credit-info{font-size:12px;color:#00eaff}
</style>
</head>

<body>

<div class="navbar">
  <h2>âš¡ YANA Admin</h2>
  <div class="profile">
    <div class="profile-pic">A</div>
    <div class="dropdown">
      <button onclick="location.href='admin-dashboard.html'">â¬… Dashboard</button>
      <button onclick="location.href='credits-history.html'">Credits History</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</div>

<div class="container">
  <h2>User Management</h2>

  <input id="searchBar" placeholder="Search by name / vendor / partner">

  <button onclick="bulkCredit()">âž• Bulk Credit</button>

  <div id="cardsContainer"></div>

  <button id="submitBtn" class="menu-btn ripple">
    <i class="fas fa-check"></i> Submit Changes
  </button>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="firebase-config.js"></script>

<script>
const cardsContainer=document.getElementById("cardsContainer");
let allUsers=[], allLocations=[], allCaptains=[], currentUserRole=null;

document.getElementById("logoutBtn").onclick=()=>auth.signOut();

auth.onAuthStateChanged(async user=>{
  if(!user) return location.href="admin-signin.html";

  const doc=await db.collection("users").doc(user.email).get();
  if(!doc.exists || doc.data().role!=="admin"){
    alert("Admins only");
    return location.href="index.html";
  }

  currentUserRole="admin";
  document.querySelector(".profile-pic").innerText=(user.email[0]||"A").toUpperCase();

  await loadLocations();
  await loadCaptains();
  loadUsers();
});

async function loadLocations(){
  const snap=await db.collection("locations").orderBy("name").get();
  allLocations=snap.docs.map(d=>({id:d.id,name:d.data().name}));
}

async function loadCaptains(){
  const snap=await db.collection("users").where("role","==","captain").get();
  allCaptains=snap.docs.map(d=>({id:d.id,name:d.data().name}));
}

function loadUsers(){
  db.collection("users").onSnapshot(snap=>{
    allUsers=[];
    cardsContainer.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data(); d.id=doc.id;
      allUsers.push(d);
    });
    renderCards();
  });
}

function renderCards(){
  cardsContainer.innerHTML="";
  allUsers.forEach(d=>{
    const card=document.createElement("div");
    card.className="card";

    const locationOptions = allLocations.map(loc=>{
      return `<option value="${loc.id}" ${d.locationId===loc.id?"selected":""}>
        ${loc.name}
      </option>`;
    }).join("");

    const captainOptions = allCaptains.map(c=>{
      return `<option value="${c.id}" ${d.captainId===c.id?"selected":""}>${c.name}</option>`;
    }).join("");

    card.innerHTML=`
      <div>
        <b>${d.name||""}</b><br>
        ${d.email}<br>
        <span class="credit-info">
          Remaining: ${d.remainingDays||0} |
          Paused: ${d.pausedDays||0} |
          Credits: ${d.creditedDays||0}
        </span>
      </div>
      <div class="card-right">
        <select data-id="${d.id}" data-field="role">
          <option value="rider" ${d.role==="rider"?"selected":""}>Rider</option>
          <option value="captain" ${d.role==="captain"?"selected":""}>Captain</option>
          <option value="admin" ${d.role==="admin"?"selected":""}>Admin</option>
        </select>

        <select data-id="${d.id}" data-field="state">
          <option value="active" ${d.state==="active"?"selected":""}>Active</option>
          <option value="inactive" ${d.state==="inactive"?"selected":""}>Inactive</option>
          <option value="blocked" ${d.state==="blocked"?"selected":""}>Blocked</option>
        </select>

        <select data-id="${d.id}" data-field="locationId">${locationOptions}</select>

        <select data-id="${d.id}" data-field="captainId">
          <option value="">--Captain--</option>
          ${captainOptions}
        </select>

        <button onclick="creditIndividual('${d.id}')">âž• Credit</button>

        <button onclick="location.href='credits-history.html?email=${d.id}'">
          ðŸ“œ History
        </button>
      </div>
    `;
    cardsContainer.appendChild(card);
  });
}

document.getElementById("searchBar").addEventListener("input",e=>{
  const term=e.target.value.toLowerCase();
  const filtered=allUsers.filter(d=>
    (d.name||"").toLowerCase().includes(term) ||
    (d.vendor||"").toLowerCase().includes(term) ||
    (d.partners||[]).join(",").toLowerCase().includes(term)
  );
  cardsContainer.innerHTML="";
  filtered.forEach(u=>renderCards([u]));
});

document.getElementById("submitBtn").onclick=async ()=>{
  const updates=[];
  document.querySelectorAll("select[data-id]").forEach(sel=>{
    updates.push(db.collection("users").doc(sel.dataset.id).update({
      [sel.dataset.field]: sel.value
    }));
  });

  if(!updates.length) return alert("No changes");
  await Promise.all(updates);
  alert("Saved");
};

async function creditIndividual(email){
  const days=parseInt(prompt("Enter number of days to credit:"),10);
  if(!days || days<=0) return;

  await db.runTransaction(async t=>{
    const ref=db.collection("users").doc(email);
    const snap=await t.get(ref);
    let current=snap.exists ? (snap.data().creditedDays||0) : 0;
    t.update(ref,{ creditedDays: current + days });

    t.set(db.collection("credits_logs").doc(),{
      email,
      days,
      reason:"Manual credit",
      creditedBy: auth.currentUser.email,
      type:"manual",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  });

  alert("Credited");
}

async function bulkCredit(){
  const days=parseInt(prompt("Credit days to ALL riders? Enter number:"),10);
  if(!days || days<=0) return;
  if(!confirm("Apply to ALL riders?")) return;

  const riders = allUsers.filter(u=>u.role==="rider");

  for(const r of riders){
    const ref=db.collection("users").doc(r.id);
    await ref.update({
      creditedDays: (r.creditedDays||0)+days
    });

    await db.collection("credits_logs").add({
      email:r.id,
      days,
      reason:"Bulk credit",
      creditedBy: auth.currentUser.email,
      type:"bulk",
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  alert("Bulk credit applied");
}
</script>
</body>
</html>
